<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiac Arrest & ROSC Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES (MATCHING TRAUMA TOOL) --- */
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        html { scroll-behavior: smooth; }
        
        /* Inputs & Controls */
        input, textarea, select { border-color: #94a3b8; outline: none; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { border-color: #2563eb; ring: 2px; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }

        /* Rich Text Output Styles */
        .rich-output {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #334155;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 24rem;
            overflow-y: auto;
            white-space: pre-wrap; 
        }

        /* Buttons */
        .std-btn { 
            transition: all 0.1s; 
            border: 1px solid #cbd5e1; 
            background-color: #f8fafc; 
            color: #334155; 
            border-radius: 0.5rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .std-btn:hover { background-color: #e2e8f0; }
        .std-btn:active { transform: translateY(1px); }

        /* Cards */
        .section-card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
            border: 2px solid #cbd5e1;
            overflow: hidden;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Toggle Radios */
        .toggle-radio:checked + div { background-color: #2563eb; color: white; border-color: #2563eb; }
        .toggle-radio-red:checked + div { background-color: #dc2626; color: white; border-color: #dc2626; }
        .toggle-radio-green:checked + div { background-color: #16a34a; color: white; border-color: #16a34a; }
        .toggle-radio-slate:checked + div { background-color: #475569; color: white; border-color: #475569; }

        /* Utility */
        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #475569; 
            margin-bottom: 0.25rem;
        }

        input[type="text"], input[type="number"], input[type="time"], select {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            border: 1px solid #94a3b8; 
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 antialiased pb-10">

    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-slate-300 no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="https://iili.io/KGQOvkl.md.png" alt="Logo" class="h-16 md:h-20 w-auto object-contain">
                <div>
                    <h1 class="text-xl md:text-2xl font-black text-slate-900 leading-tight">Cardiac Arrest & ROSC</h1>
                    <p class="text-xs text-green-600 font-bold flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Active Tool
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="https://wmebemals.netlify.app" target="_blank" class="hidden sm:inline-flex items-center gap-2 px-3 py-1 text-xs font-bold text-red-700 bg-red-50 rounded border border-red-200 hover:bg-red-100 transition">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Run Arrest (ALS)
                </a>
                <div class="hidden md:block text-right border-l pl-4 border-slate-200 ml-2">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">WMEBEM</p>
                    <p class="text-xs font-bold text-slate-800">Dr Jake Turner</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-7xl px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-8 flex flex-col gap-6">

                <a href="https://wmebemals.netlify.app" target="_blank" class="sm:hidden flex items-center justify-center w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition shadow-md border-2 border-red-800 text-sm uppercase">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Open ALS Algorithm Tool
                </a>

                <div class="section-card border-l-[8px] border-l-slate-600">
                    <div class="section-title text-slate-800">Pre-Hospital Handover</div>
                    
                    <div class="grid grid-cols-4 sm:grid-cols-12 gap-4 mb-4">
                         <div class="col-span-1 sm:col-span-3">
                            <label for="age">Age</label>
                            <input type="number" id="age" class="text-center font-bold" placeholder="--">
                        </div>
                        <div class="col-span-3 sm:col-span-9">
                            <label for="patient_details">Patient Details</label>
                            <input type="text" id="patient_details" class="font-bold" placeholder="Name, DOB, Hospital No.">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label>Witnessed Status</label>
                            <div class="flex rounded-md shadow-sm bg-slate-100 p-1 border border-slate-300">
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="witness_status" value="Unwitnessed" checked class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">No</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="witness_status" value="Bystander" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">Bystander</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="witness_status" value="Paramedic" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">Paramedic</div></label>
                            </div>
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center justify-center w-full p-2 bg-white border border-slate-400 rounded-md cursor-pointer hover:bg-blue-50 transition h-[42px]">
                                <input type="checkbox" id="bystander_cpr" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-slate-400">
                                <span class="ml-2 text-sm font-bold text-slate-700">Bystander CPR?</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div><label>History / PC</label><textarea id="prearrest_history" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Events leading to arrest..."></textarea></div>
                        <div><label>Pre-Arrest Interventions</label><textarea id="prearrest_interventions" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Meds given..."></textarea></div>
                    </div>
                </div>

                <div class="section-card border-l-[8px] border-l-slate-800">
                    <div class="section-title text-slate-900">Timeline & Events</div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
                        <label class="cursor-pointer group">
                            <input type="checkbox" id="arrestOnArrival" class="sr-only toggle-radio-red peer">
                            <div class="w-full p-4 text-center border-2 border-slate-300 bg-slate-50 rounded-lg font-black text-slate-500 group-hover:bg-white transition shadow-sm uppercase tracking-wide text-sm">
                                Arrest on Arrival?
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="checkbox" id="roscAchieved" class="sr-only toggle-radio-green peer">
                            <div class="w-full p-4 text-center border-2 border-slate-300 bg-slate-50 rounded-lg font-black text-slate-500 group-hover:bg-white transition shadow-sm uppercase tracking-wide text-sm">
                                ROSC Achieved?
                            </div>
                        </label>
                    </div>

                    <div id="rearrestContainer" class="hidden mb-5">
                        <label class="cursor-pointer block">
                            <input type="checkbox" id="rearrested" class="sr-only peer">
                            <div class="w-full p-3 text-center border-2 border-red-300 bg-red-50 text-red-800 rounded-lg font-black uppercase tracking-wide peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600 transition shadow-sm">
                                !!! Patient Re-Arrested Post-ROSC !!!
                            </div>
                        </label>
                    </div>

                    <div id="timeline_details" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                        <h3 class="font-black text-blue-900 mb-3 text-sm uppercase">Arrest Timeline</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                            <div><label class="text-blue-800">Collapse</label><input type="time" id="time_collapse" class="border-blue-300 font-bold"></div>
                            <div><label class="text-blue-800">1st CPR</label><input type="time" id="time_cpr" class="border-blue-300 font-bold"></div>
                            <div><label class="text-blue-800">Defib</label><input type="time" id="time_defib" class="border-blue-300 font-bold"></div>
                            <div><label class="text-blue-800">ROSC</label><input type="time" id="time_rosc" class="border-blue-300 font-bold"></div>
                        </div>
                         <div class="mb-4">
                            <label class="text-blue-800">Total Downtime</label>
                            <div class="relative flex items-center">
                                <input type="number" id="downtime" class="border-blue-300 font-black text-slate-900" readonly>
                                <span class="absolute right-3 text-xs font-bold text-slate-500">mins</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="text-blue-800">Initial Rhythm(s)</label>
                                <div id="initialRhythm" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <label class="text-blue-800">Shocks</label>
                                <input type="number" id="shocks" class="border-blue-300 font-bold mb-2">
                                <label class="text-blue-800">Arrest Drugs</label>
                                <textarea id="prehospital_drugs" class="border-blue-300 font-medium" rows="1"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-2 text-center border-b-4 border-slate-900 pb-2 mb-2">
                    <h2 class="text-3xl font-black text-slate-900 uppercase tracking-widest">Post-ROSC Survey</h2>
                </div>

                <div class="section-card border-l-[8px] border-l-blue-600">
                    <div class="section-title text-blue-800">A - Airway</div>
                    <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-3 border border-slate-300">
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airway_type" value="Patent" checked class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">Patent</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airway_type" value="iGel/LMA" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">iGel</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airway_type" value="ETT" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">ETT</div></label>
                    </div>
                    <textarea id="airway_notes" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Size, depth, cuff pressure..."></textarea>
                </div>

                <div class="section-card border-l-[8px] border-l-sky-400">
                    <div class="section-title text-sky-700">B - Breathing</div>
                    <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-4 border border-slate-300">
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Clear Bilat" checked class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">Clear</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Wheeze" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">Wheeze</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Creps" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">Creps</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Silent/Reduced" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition">Silent</div></label>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label>RR</label><input type="number" id="breathing_rr" class="text-center text-lg font-mono font-bold"></div>
                        <div><label>Sats (%)</label><input type="number" id="breathing_sats" class="text-center text-lg font-mono font-bold"></div>
                        <div><label>EtCO2</label><input type="number" id="breathing_etco2" class="text-center text-lg font-mono font-bold" placeholder="kPa"></div>
                    </div>
                </div>

                <div class="section-card border-l-[8px] border-l-red-600">
                    <div class="section-title text-red-700">C - Circulation</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                        <div><label>HR</label><input type="number" id="circ_hr" class="text-center text-lg font-mono font-bold focus:ring-red-500"></div>
                        <div><label>BP</label><input type="text" id="circ_bp" class="text-center text-lg font-mono font-bold focus:ring-red-500" placeholder="120/80"></div>
                        <div><label>MAP</label><input type="number" id="circ_map" class="text-center text-lg font-mono font-bold focus:ring-red-500"></div>
                        <div><label>Temp</label><input type="number" id="circ_temp" class="text-center text-lg font-mono font-bold focus:ring-red-500"></div>
                    </div>
                    <textarea id="circ_notes" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Peripheries, support requirements..."></textarea>
                </div>

                <div class="section-card border-l-[8px] border-l-yellow-400">
                    <div class="section-title text-yellow-700">D - Disability</div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                         <div><label>Eyes</label><select id="disability_gcsE" class="text-sm font-bold"></select></div>
                         <div><label>Verbal</label><select id="disability_gcsV" class="text-sm font-bold"></select></div>
                         <div><label>Motor</label><select id="disability_gcsM" class="text-sm font-bold"></select></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label>Pupils</label>
                            <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-2 border border-slate-300">
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupils_equal" value="Equal" checked class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition">Equal</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupils_equal" value="Unequal" class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition">Unequal</div></label>
                            </div>
                            <input type="text" id="disability_pupils_size" class="font-bold" placeholder="Size (e.g. 3mm)">
                        </div>
                        <div>
                            <label>Reactivity</label>
                            <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-2 border border-slate-300">
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupilReactivity" value="Yes" class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition">Reactive</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupilReactivity" value="None" checked class="sr-only toggle-radio-red peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition text-red-700">Fixed/None</div></label>
                            </div>
                            <div class="relative">
                                <input type="number" id="disability_glucose" class="font-bold">
                                <span class="absolute right-3 top-2.5 text-xs font-bold text-slate-500">mmol/L</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card border-l-[8px] border-l-green-600">
                    <div class="section-title text-green-700">E - Exposure</div>
                    <div class="mb-3 w-1/3">
                        <label>Temperature (°C)</label>
                        <input type="number" id="exposure_temp" class="font-bold" placeholder="--.-">
                    </div>
                    <textarea id="exposure_notes" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Trauma check, lines, rashes..."></textarea>
                </div>

                <div class="section-card border-l-[8px] border-l-slate-400">
                    <div class="section-title text-slate-700">Suspected Cause(s)</div>
                    <div id="reversibles" class="flex flex-wrap gap-2 mb-3"></div>
                    <textarea id="reversibles_notes" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" placeholder="Details..."></textarea>
                </div>

                <div class="section-card border-l-[8px] border-l-purple-600">
                    <div class="section-title text-purple-800">
                        Blood Gas
                        <div class="flex rounded-md shadow-sm bg-slate-100 p-1 border border-slate-300 ml-4">
                            <label class="cursor-pointer flex-1"><input type="radio" name="gas_type" value="VBG" checked class="sr-only toggle-radio peer"><div class="px-4 py-1.5 rounded text-xs font-bold transition">VBG</div></label>
                            <label class="cursor-pointer flex-1"><input type="radio" name="gas_type" value="ABG" class="sr-only toggle-radio peer"><div class="px-4 py-1.5 rounded text-xs font-bold transition">ABG</div></label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div><label>FiO2</label><input type="text" id="gas_fio2" class="font-bold" placeholder="% or Flow"></div>
                        <div class="border-l-4 border-red-500 pl-2"><label class="text-red-600">pH</label><input type="number" step="0.01" id="gas_ph" class="text-lg font-black focus:ring-red-500"></div>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
                        <div><label>pCO2</label><input type="number" step="0.1" id="gas_pco2" class="text-center font-mono font-bold"></div>
                        <div><label>pO2</label><input type="number" step="0.1" id="gas_po2" class="text-center font-mono font-bold"></div>
                        <div><label>HCO3</label><input type="number" step="0.1" id="gas_hco3" class="text-center font-mono font-bold"></div>
                        <div><label>BE</label><input type="number" step="0.1" id="gas_be" class="text-center font-mono font-bold"></div>
                        <div><label class="text-purple-700">Lac</label><input type="number" step="0.1" id="gas_lactate" class="text-center font-mono font-black text-purple-700 border-2 border-purple-300"></div>
                        <div><label>K+</label><input type="number" step="0.1" id="gas_k" class="text-center font-mono font-bold"></div>
                    </div>
                </div>

                <div class="bg-red-50 p-5 rounded-xl shadow-sm border-2 border-red-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-black text-red-900">MIRACLE² Score</h2>
                        <div class="text-right bg-white px-4 py-2 rounded-lg border-2 border-red-100 shadow-sm">
                             <span id="miracle2_score" class="text-3xl font-black text-red-600 block leading-none">0</span>
                             <span id="miracle2_outcome" class="text-[10px] font-bold text-slate-500 block uppercase">~3% Risk</span>
                        </div>
                    </div>
                    
                    <div id="miracle2_inputs" class="space-y-2 mb-3 text-sm"></div>
                    <p class="text-[10px] text-red-400 text-center uppercase font-bold mt-4">Manual overrides enabled</p>
                </div>

                <div class="section-card border-2 border-slate-300 border-t-[8px] border-t-slate-800">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-black text-slate-800">Management Plan</h2>
                        <a href="https://www.resus.org.uk/sites/default/files/2025-10/Adult%20post-resuscitation%20care%202025.pdf" target="_blank" class="text-xs font-bold text-blue-600 hover:text-white hover:bg-blue-600 transition flex items-center bg-blue-50 px-3 py-1.5 rounded border border-blue-200">
                            RCUK 2025 Bundle
                            <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-5">
                        <h4 class="text-xs font-black text-blue-900 uppercase mb-3">Post-ROSC Care Bundle Checklist</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-5 h-5 text-blue-600 rounded border border-blue-300" value="SpO2 94-98%"><span class="text-sm font-bold text-slate-700">SpO2 94-98%</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-5 h-5 text-blue-600 rounded border border-blue-300" value="Normocapnia"><span class="text-sm font-bold text-slate-700">Normocapnia</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-5 h-5 text-blue-600 rounded border border-blue-300" value="12 Lead ECG"><span class="text-sm font-bold text-slate-700">12 Lead ECG</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-5 h-5 text-blue-600 rounded border border-blue-300" value="Avoid Fever"><span class="text-sm font-bold text-slate-700">Avoid fever</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-5 h-5 text-blue-600 rounded border border-blue-300" value="MAP > 65"><span class="text-sm font-bold text-slate-700">MAP > 65</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-5 h-5 text-blue-600 rounded border border-blue-300" value="Glucose Control"><span class="text-sm font-bold text-slate-700">Glucose Control</span></label>
                        </div>
                        <button id="addBundleBtn" class="w-full py-2 bg-blue-600 text-white text-xs font-bold rounded shadow hover:bg-blue-700 transition uppercase tracking-wide">ADD CHECKED ITEMS TO PLAN</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div><label>ECG / Imaging Findings</label><textarea id="plan_ecg" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" rows="1" placeholder="Findings..."></textarea></div>
                        <div><label>Immediate Management</label><textarea id="plan_management" class="w-full px-3 py-2 border border-slate-400 rounded-md text-sm font-medium" rows="3" placeholder="Referrals, Drugs, Transfers..."></textarea></div>
                    </div>

                    <div class="mt-6 pt-4 border-t-2 border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                         <span class="text-sm font-black text-slate-800 uppercase">For Further Resuscitation?</span>
                         <div class="flex rounded-md shadow-sm bg-slate-100 p-1 border border-slate-300">
                            <label class="cursor-pointer"><input type="radio" name="further_resus" value="Yes" checked class="sr-only toggle-radio-green peer"><div class="px-6 py-2 rounded text-xs font-bold transition border border-transparent">YES</div></label>
                            <label class="cursor-pointer"><input type="radio" name="further_resus" value="No" class="sr-only toggle-radio-red peer"><div class="px-6 py-2 rounded text-xs font-bold transition border border-transparent">NO</div></label>
                        </div>
                    </div>
                </div>
                
                 <button id="clearForm" class="w-full py-4 text-red-600 bg-white hover:bg-red-50 font-bold rounded-xl transition-colors border-2 border-slate-300 shadow-sm mt-4 uppercase tracking-widest text-sm flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Clear All Data
                </button>

                <footer class="mt-8 py-8 text-center border-t border-slate-300">
                    <p class="text-xs text-slate-500 font-bold mb-1">&copy; 2025 West Midlands Evidence Based Emergency Medicine.</p>
                </footer>

            </div>

            <div class="lg:col-span-4 relative">
                <div class="sticky top-24 h-fit no-print space-y-4">
                    <div id="epr-log-container" class="bg-white p-4 rounded-xl shadow-lg border border-slate-300">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Generated Note</h2>
                            <button type="button" id="copySummary" class="px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow-sm">
                                Copy Text
                            </button>
                        </div>
                        <textarea readonly id="summaryNoteOutput" class="w-full h-[60vh] p-3 bg-slate-50 border border-slate-300 rounded-md font-mono text-xs leading-relaxed resize-none focus:outline-none"></textarea>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const patientData = {
                age: '', patientDetails: '',
                witnessStatus: 'Unwitnessed', bystanderCPR: false,
                prearrest: { history: '', interventions: '' },
                arrestOnArrival: false, roscAchieved: false, rearrested: false,
                timeline: { collapse: '', cpr: '', defib: '', rosc: '', downtime: '' },
                rhythms: [], shocks: '', prehospital_drugs: '',
                postROSC: {
                    airway: { type: 'Patent', notes: '' },
                    breathing: { rr: '', sats: '', etco2: '', sounds: 'Clear Bilat' },
                    circulation: { hr: '', bp: '', map: '', temp: '', notes: '' },
                    disability: { gcsE: 1, gcsV: 1, gcsM: 1, pupilsEq: 'Equal', pupilsSize: '', pupilReactivity: 'None', glucose: '' },
                    exposure: { temp: '', notes: '' },
                },
                reversibles: { checked: [], notes: '' },
                bloodGas: { type: 'VBG', fio2: '', ph: '', pco2: '', po2: '', hco3: '', be: '', lactate: '', k: '' },
                miracle2: {
                    score: 0,
                    // null = auto, 1/0 = manual
                    missed: 1, nonShockable: 0, pupilReactivity: 1, age: 0, phLow: 0, 
                    changingRhythms: 0, adrenaline: 0
                },
                plan: { ecg: '', management: '', furtherResus: 'Yes' }
            };

            const RHYTHMS = ['VF', 'pVT', 'PEA', 'Asystole'];
            const REVERSIBLES = ['Hypoxia', 'Hypovolaemia', 'Hypo/HyperK+', 'Hypothermia', 'Thrombosis', 'Tamponade', 'Toxins', 'Tension PTX'];
            const MIRACLE2_OUTCOMES = { 0: '~3%', 1: '~6%', 2: '~15%', 3: '~30%', 4: '~50%', 5: '~70%', 6: '~85%', 7: '~95%', 8: '~98%', 9: '~99%', 10: '>99%' };
            
            const getEl = (id) => document.getElementById(id);

            // --- NOTE GENERATOR ---
            function updateNotes() {
                const d = new Date();
                const timestamp = `${d.getDate()}/${d.getMonth()+1} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                
                let n = `*** CARDIAC ARREST PROFORMA ***\nDoc: ${timestamp}\n\n`;
                
                n += `ID: ${patientData.patientDetails || 'Unknown'} | Age: ${patientData.age || '?'}\n`;
                n += `Witnessed: ${patientData.witnessStatus} | Bystander CPR: ${patientData.bystanderCPR?'YES':'No'}\n`;
                n += `Hx: ${patientData.prearrest.history || '-'}\nRx: ${patientData.prearrest.interventions || '-'}\n\n`;
                
                n += `--- EVENTS ---\n`;
                n += `Arrest on Arrival: ${patientData.arrestOnArrival?'YES':'No'} | Pre-Hosp ROSC: ${patientData.roscAchieved?'YES':'No'}\n`;
                if(patientData.rearrested) n += `!!! PATIENT RE-ARRESTED POST-ROSC !!!\n`;
                
                if(patientData.arrestOnArrival || patientData.roscAchieved) {
                    const t = patientData.timeline;
                    n += `Times: Col ${t.collapse||'-'} / CPR ${t.cpr||'-'} / Defib ${t.defib||'-'} / ROSC ${t.rosc||'-'}\n`;
                    n += `Total Downtime: ${t.downtime||'?'} mins\n`;
                    n += `Rhythms: ${patientData.rhythms.join(', ')}\n`;
                    n += `Shocks: ${patientData.shocks||'0'} | Drugs: ${patientData.prehospital_drugs||'-'}\n`;
                }
                
                n += `\n--- POST-ROSC ---\n`;
                const pr = patientData.postROSC;
                n += `A: ${pr.airway.type}. ${pr.airway.notes}\n`;
                n += `B: ${pr.breathing.sounds}. RR ${pr.breathing.rr||'-'} Sats ${pr.breathing.sats||'-'}% EtCO2 ${pr.breathing.etco2||'-'}\n`;
                n += `C: HR ${pr.circulation.hr||'-'} BP ${pr.circulation.bp||'-'} MAP ${pr.circulation.map||'-'} T ${pr.circulation.temp||'-'}. ${pr.circulation.notes}\n`;
                
                const gcs = parseInt(pr.disability.gcsE)+parseInt(pr.disability.gcsV)+parseInt(pr.disability.gcsM);
                n += `D: GCS ${gcs} (E${pr.disability.gcsE}V${pr.disability.gcsV}M${pr.disability.gcsM}). Pupils: ${pr.disability.pupilsEq} ${pr.disability.pupilsSize} (${pr.disability.pupilReactivity}). BM ${pr.disability.glucose||'-'}\n`;
                n += `E: Temp ${pr.exposure.temp||'-'}°C. ${pr.exposure.notes||'-'}\n`;
                
                n += `\nSuspected Cause(s): ${patientData.reversibles.checked.join(', ') || 'None selected'}. ${patientData.reversibles.notes}\n`;
                
                const gas = patientData.bloodGas;
                n += `Gas (${gas.type}): FiO2 ${gas.fio2||'-'} | pH ${gas.ph} | pCO2 ${gas.pco2} | pO2 ${gas.po2} | Lac ${gas.lactate} | K ${gas.k}\n`;
                
                const m2 = patientData.miracle2;
                n += `\nMIRACLE² Score: ${m2.score} (${MIRACLE2_OUTCOMES[m2.score] || '?'})\n`;
                
                n += `\n--- PLAN ---\n`;
                n += `Further Resus: ${patientData.plan.furtherResus.toUpperCase()}\n`;
                n += `ECG/Img: ${patientData.plan.ecg||'-'}\n`;
                n += `Mgmt: ${patientData.plan.management||'-'}`;
                
                getEl('summaryNoteOutput').value = n;
            }

            // --- CALCULATORS ---
            function calcDowntime() {
                const c = getEl('time_collapse').value;
                const r = getEl('time_rosc').value;
                if(c && r) {
                    const d1 = new Date(`1970-01-01T${c}:00`);
                    const d2 = new Date(`1970-01-01T${r}:00`);
                    if(d2 < d1) d2.setDate(d2.getDate()+1);
                    const diff = Math.round((d2-d1)/60000);
                    patientData.timeline.downtime = diff;
                    getEl('downtime').value = diff;
                }
            }

            function calcMiracle2() {
                const m = patientData.miracle2;
                m.score = m.missed + m.nonShockable + m.pupilReactivity + m.age + m.changingRhythms + m.phLow + (m.adrenaline * 2);
                getEl('miracle2_score').textContent = m.score;
                getEl('miracle2_outcome').textContent = MIRACLE2_OUTCOMES[m.score] || '?';
                updateNotes();
            }

            // --- INIT ---
            function init() {
                // Checkboxes
                const mkCheck = (val, id) => `<label class="cursor-pointer flex items-center space-x-2 p-1.5 border border-slate-300 rounded hover:bg-slate-50 transition bg-white"><input type="checkbox" value="${val}" class="${id} w-4 h-4 text-blue-600 rounded border-slate-400"> <span class="text-xs font-bold text-slate-700">${val}</span></label>`;
                
                getEl('initialRhythm').innerHTML = RHYTHMS.map(r => mkCheck(r, 'rhythm-check')).join('');
                getEl('reversibles').innerHTML = REVERSIBLES.map(r => mkCheck(r, 'rev-check')).join('');

                // Miracle 2 Rows
                const m2Con = getEl('miracle2_inputs');
                const m2Items = [
                    { id: 'missed', label: 'Unwitnessed' },
                    { id: 'nonShockable', label: 'Non-shockable Rhythm' },
                    { id: 'pupilReactivity', label: 'No Pupil Reactivity' },
                    { id: 'phLow', label: 'pH < 7.20' },
                    { id: 'changingRhythms', label: 'Changing Rhythms (≥2)' },
                    { id: 'adrenaline', label: 'Epinephrine Given' }
                ];
                
                m2Items.forEach(i => {
                    m2Con.innerHTML += `
                    <div class="flex justify-between items-center border-b border-red-200 pb-2 last:border-0">
                        <span class="text-xs font-bold text-slate-700">${i.label}</span>
                        <div class="flex space-x-1">
                            <label class="cursor-pointer"><input type="radio" name="m2_${i.id}" value="1" class="sr-only peer"><span class="px-2 py-0.5 rounded text-[10px] font-bold border border-slate-300 bg-white text-slate-400 peer-checked:bg-red-100 peer-checked:text-red-700 peer-checked:border-red-400 hover:bg-slate-50">YES</span></label>
                            <label class="cursor-pointer"><input type="radio" name="m2_${i.id}" value="0" class="sr-only peer"><span class="px-2 py-0.5 rounded text-[10px] font-bold border border-slate-300 bg-white text-slate-400 peer-checked:bg-slate-200 peer-checked:text-slate-700 peer-checked:border-slate-400 hover:bg-slate-50">NO</span></label>
                        </div>
                    </div>`;
                });
                m2Con.innerHTML += `<div class="flex justify-between items-center pt-1 border-t border-red-200 mt-2"><span class="text-xs font-bold text-slate-700">Age Points (0, 1, 3)</span><span id="m2_age_disp" class="text-xs font-black text-slate-500 bg-slate-100 px-2 py-1 rounded border border-slate-300">0</span></div>`;
                
                m2Items.forEach(i => document.querySelector(`input[name="m2_${i.id}"][value="0"]`).checked = true);

                // GCS
                const popSel = (id, max) => {
                    const s = getEl(id);
                    for(let i=max; i>=1; i--) s.add(new Option(i,i));
                };
                popSel('disability_gcsE', 4); popSel('disability_gcsV', 5); popSel('disability_gcsM', 6);

                setupListeners();
                updateNotes();
            }

            // --- LISTENERS ---
            function setupListeners() {
                // Re-arrest Toggle logic
                const ar = getEl('arrestOnArrival');
                const ro = getEl('roscAchieved');
                const rearrestCont = getEl('rearrestContainer');
                
                const toggleTimeline = () => {
                     const show = ar.checked || ro.checked;
                     getEl('timeline_details').classList.toggle('hidden', !show);
                     patientData.arrestOnArrival = ar.checked;
                     patientData.roscAchieved = ro.checked;
                     
                     if(ro.checked) rearrestCont.classList.remove('hidden');
                     else {
                        rearrestCont.classList.add('hidden');
                        patientData.rearrested = false;
                        getEl('rearrested').checked = false;
                     }
                     updateNotes();
                };
                ar.addEventListener('change', toggleTimeline);
                ro.addEventListener('change', toggleTimeline);
                
                getEl('rearrested').addEventListener('change', e => { patientData.rearrested = e.target.checked; updateNotes(); });

                // M2 Logic
                const setM2 = (key, val) => {
                    patientData.miracle2[key] = val;
                    document.querySelector(`input[name="m2_${key}"][value="${val}"]`).checked = true;
                    calcMiracle2();
                };

                getEl('age').addEventListener('input', e => {
                    const v = parseInt(e.target.value);
                    patientData.age = v;
                    let p = 0; if(v>80) p=3; else if(v>=60) p=1;
                    patientData.miracle2.age = p;
                    getEl('m2_age_disp').textContent = p;
                    calcMiracle2();
                });

                getEl('witness_status').addEventListener('change', e => {
                    patientData.witnessStatus = e.target.value;
                    setM2('missed', e.target.value === 'Unwitnessed' ? 1 : 0);
                    updateNotes();
                });

                getEl('gas_ph').addEventListener('input', e => {
                    patientData.bloodGas.ph = e.target.value;
                    if(e.target.value && parseFloat(e.target.value) < 7.20) setM2('phLow', 1); else setM2('phLow', 0);
                    updateNotes();
                });

                document.body.addEventListener('change', e => {
                    if(e.target.classList.contains('rhythm-check')) {
                        const val = e.target.value;
                        if(e.target.checked) patientData.rhythms.push(val); 
                        else patientData.rhythms = patientData.rhythms.filter(x=>x!==val);
                        
                        const nonShock = patientData.rhythms.some(r=>['PEA','Asystole'].includes(r)) && !patientData.rhythms.some(r=>['VF','pVT'].includes(r));
                        setM2('nonShockable', nonShock ? 1 : 0);
                        updateNotes();
                    }
                });

                document.querySelectorAll('input[name="pupilReactivity"]').forEach(el => el.addEventListener('change', e => {
                    patientData.postROSC.disability.pupilReactivity = e.target.value;
                    setM2('pupilReactivity', e.target.value === 'None' ? 1 : 0);
                    updateNotes();
                }));

                // M2 Manual Override
                document.querySelectorAll('input[name^="m2_"]').forEach(el => {
                    el.addEventListener('change', e => {
                        const key = e.target.name.replace('m2_', '');
                        patientData.miracle2[key] = parseInt(e.target.value);
                        calcMiracle2();
                    });
                });

                // Auto-expand textarea
                document.querySelectorAll('textarea').forEach(el => {
                    el.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });
                });

                // Generic Binding
                const bind = (id, root, key) => {
                    getEl(id).addEventListener('input', e => { root[key] = e.target.value; updateNotes(); });
                };
                
                // Mappings
                bind('patient_details', patientData, 'patientDetails');
                bind('prearrest_history', patientData.prearrest, 'history');
                bind('prearrest_interventions', patientData.prearrest, 'interventions');
                bind('time_collapse', patientData.timeline, 'collapse');
                bind('time_cpr', patientData.timeline, 'cpr');
                bind('time_defib', patientData.timeline, 'defib');
                bind('time_rosc', patientData.timeline, 'rosc');
                bind('shocks', patientData, 'shocks');
                bind('prehospital_drugs', patientData, 'prehospital_drugs');
                bind('airway_notes', patientData.postROSC.airway, 'notes');
                bind('breathing_rr', patientData.postROSC.breathing, 'rr');
                bind('breathing_sats', patientData.postROSC.breathing, 'sats');
                bind('breathing_etco2', patientData.postROSC.breathing, 'etco2');
                bind('circ_hr', patientData.postROSC.circulation, 'hr');
                bind('circ_bp', patientData.postROSC.circulation, 'bp');
                bind('circ_map', patientData.postROSC.circulation, 'map');
                bind('circ_temp', patientData.postROSC.circulation, 'temp');
                bind('circ_notes', patientData.postROSC.circulation, 'notes');
                bind('disability_gcsE', patientData.postROSC.disability, 'gcsE'); 
                bind('disability_gcsV', patientData.postROSC.disability, 'gcsV');
                bind('disability_gcsM', patientData.postROSC.disability, 'gcsM');
                bind('disability_pupils_size', patientData.postROSC.disability, 'pupilsSize');
                bind('disability_glucose', patientData.postROSC.disability, 'glucose');
                bind('exposure_temp', patientData.postROSC.exposure, 'temp');
                bind('exposure_notes', patientData.postROSC.exposure, 'notes');
                bind('reversibles_notes', patientData.reversibles, 'notes');
                bind('gas_fio2', patientData.bloodGas, 'fio2');
                bind('gas_pco2', patientData.bloodGas, 'pco2');
                bind('gas_po2', patientData.bloodGas, 'po2');
                bind('gas_hco3', patientData.bloodGas, 'hco3');
                bind('gas_be', patientData.bloodGas, 'be');
                bind('gas_lactate', patientData.bloodGas, 'lactate');
                bind('gas_k', patientData.bloodGas, 'k');
                bind('plan_ecg', patientData.plan, 'ecg');
                bind('plan_management', patientData.plan, 'management');

                ['time_collapse', 'time_rosc'].forEach(id => getEl(id).addEventListener('input', calcDowntime));

                document.querySelectorAll('input[name="airway_type"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.airway.type = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="breath_sounds"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.breathing.sounds = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="pupils_equal"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.disability.pupilsEq = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="gas_type"]').forEach(r => r.addEventListener('change', e => { patientData.bloodGas.type = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="further_resus"]').forEach(r => r.addEventListener('change', e => { patientData.plan.furtherResus = e.target.value; updateNotes(); }));

                document.body.addEventListener('change', e => {
                    if(e.target.classList.contains('rev-check')) {
                        const v = e.target.value;
                        if(e.target.checked) patientData.reversibles.checked.push(v);
                        else patientData.reversibles.checked = patientData.reversibles.checked.filter(x=>x!==v);
                        updateNotes();
                    }
                });
                
                getEl('addBundleBtn').addEventListener('click', () => {
                    const checked = Array.from(document.querySelectorAll('.bundle-check:checked')).map(c => c.value);
                    if(checked.length > 0) {
                        const current = getEl('plan_management').value;
                        const addition = "RCUK 2025 Care Bundle: " + checked.join(', ');
                        getEl('plan_management').value = current ? current + "\n" + addition : addition;
                        patientData.plan.management = getEl('plan_management').value;
                        updateNotes();
                    }
                });

                getEl('clearForm').addEventListener('click', () => { if(confirm('Reset all data?')) location.reload(); });
                getEl('copySummary').addEventListener('click', () => { 
                    navigator.clipboard.writeText(getEl('summaryNoteOutput').value); 
                    const btn = getEl('copySummary');
                    btn.textContent = 'COPIED!';
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    setTimeout(() => {
                        btn.textContent = 'COPY TEXT';
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    }, 2000);
                });
            }

            init();
        });
    </script>
</body>
</html>
