<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiac Arrest & ROSC Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        html { scroll-behavior: smooth; }
        
        /* Toggle Radio Logic (Trauma Tool Style) */
        .toggle-radio:checked + div {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-color: #2563eb;
        }
        .toggle-radio-red:checked + div {
            background-color: #dc2626; /* red-600 */
            color: white;
            border-color: #dc2626;
        }
        .toggle-radio-green:checked + div {
            background-color: #16a34a; /* green-600 */
            color: white;
            border-color: #16a34a;
        }
        .toggle-radio-slate:checked + div {
            background-color: #475569; /* slate-600 */
            color: white;
            border-color: #475569;
        }

        /* Standard Input Styling */
        input[type="text"], input[type="number"], input[type="time"], select, textarea {
            @apply w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow;
        }
        
        label.section-label {
            @apply block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wide;
        }
        
        /* Tag Checkbox Logic */
        .tag-checkbox:checked + span {
            background-color: #e2e8f0;
            border-color: #94a3b8;
            color: #1e293b;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased h-screen flex flex-col overflow-hidden">

    <header class="bg-white shadow-sm border-b border-slate-200 shrink-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-10 w-auto object-contain">
                <div>
                    <h1 class="text-xl font-black text-slate-900 flex items-center gap-2 uppercase tracking-tight">
                        Cardiac Arrest Tool
                    </h1>
                </div>
            </div>
            <div class="hidden sm:block text-right">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Designed By</p>
                <p class="text-xs font-bold text-slate-700">Dr Jake Turner</p>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6 overflow-hidden">
        <div class="h-full grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-7 xl:col-span-8 h-full overflow-y-auto pr-2 pb-20 space-y-6">

                <section class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-900 mb-4 flex items-center">
                        <span class="w-1.5 h-6 bg-slate-800 mr-2 rounded-full"></span>Pre-Hospital Handover
                    </h2>
                    
                    <div class="grid grid-cols-4 sm:grid-cols-12 gap-4 mb-4">
                        <div class="col-span-1 sm:col-span-2">
                           <label class="section-label">Age</label>
                           <input type="number" id="age" class="text-center font-bold" placeholder="--">
                       </div>
                       <div class="col-span-3 sm:col-span-10">
                           <label class="section-label">Patient Details</label>
                           <input type="text" id="patient_details" placeholder="Name, DOB, Hospital No.">
                       </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="section-label">Witnessed Status</label>
                            <div class="flex rounded-md shadow-sm bg-slate-100 p-1">
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="witness_status" value="Unwitnessed" checked class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition border border-transparent">No</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="witness_status" value="Bystander" class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition border border-transparent">Bystander</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="witness_status" value="Paramedic" class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition border border-transparent">Para</div></label>
                            </div>
                        </div>
                        <div class="flex items-end pb-1">
                             <label class="flex items-center justify-center p-2 border border-slate-300 bg-slate-50 rounded hover:bg-white cursor-pointer w-full transition shadow-sm h-[38px]">
                                <input type="checkbox" id="bystander_cpr" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-slate-300">
                                <span class="ml-2 text-sm font-bold text-slate-700">Bystander CPR?</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div><label class="section-label">History / PC</label><textarea id="prearrest_history" rows="1" placeholder="Events leading to arrest..."></textarea></div>
                        <div><label class="section-label">Pre-Arrest Interventions</label><textarea id="prearrest_interventions" rows="1" placeholder="Meds given..."></textarea></div>
                    </div>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-900 mb-4 flex items-center">
                        <span class="w-1.5 h-6 bg-blue-600 mr-2 rounded-full"></span>Events & Timeline
                    </h2>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5 pb-5 border-b border-slate-100">
                        <label class="cursor-pointer group">
                            <input type="checkbox" id="arrestOnArrival" class="sr-only toggle-radio-red peer">
                            <div class="w-full p-4 text-center border-2 border-slate-200 bg-slate-50 rounded-lg font-bold text-slate-600 group-hover:border-slate-300 transition shadow-sm">
                                ARREST ON ARRIVAL?
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="checkbox" id="roscAchieved" class="sr-only toggle-radio-green peer">
                            <div class="w-full p-4 text-center border-2 border-slate-200 bg-slate-50 rounded-lg font-bold text-slate-600 group-hover:border-slate-300 transition shadow-sm">
                                ROSC ACHIEVED?
                            </div>
                        </label>
                    </div>

                    <div id="rearrestContainer" class="hidden mb-5">
                        <label class="cursor-pointer block">
                            <input type="checkbox" id="rearrested" class="sr-only peer">
                            <div class="w-full p-3 text-center border-2 border-red-200 bg-red-50 text-red-800 rounded-lg font-black uppercase tracking-wide peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600 transition shadow-sm">
                                Patient Re-Arrested Post-ROSC
                            </div>
                        </label>
                    </div>

                    <div id="timeline_inputs" class="hidden animate-fade-in">
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-4">
                            <div><label class="section-label">Collapse</label><input type="time" id="time_collapse"></div>
                            <div><label class="section-label">CPR</label><input type="time" id="time_cpr"></div>
                            <div><label class="section-label">Defib</label><input type="time" id="time_defib"></div>
                            <div><label class="section-label">ROSC</label><input type="time" id="time_rosc"></div>
                            <div><label class="section-label">Downtime</label><input type="text" id="downtime" readonly class="bg-slate-100 font-bold text-center text-slate-500" placeholder="mins"></div>
                        </div>

                        <div class="mb-4">
                            <label class="section-label">Initial Rhythm(s)</label>
                            <div class="flex flex-wrap gap-2" id="initialRhythm">
                                </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div><label class="section-label">Shocks</label><input type="number" id="shocks" placeholder="#"></div>
                             <div><label class="section-label">Arrest Drugs</label><input type="text" id="prehospital_drugs" placeholder="Adrenaline, Amiodarone..."></div>
                        </div>
                    </div>
                </section>

                <div class="pt-2"><h2 class="text-2xl font-black text-slate-800 border-b-2 border-slate-200 pb-2 uppercase tracking-tight">Post-ROSC Survey</h2></div>

                <section class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-blue-500 border-y border-r border-slate-200">
                    <h3 class="text-lg font-bold text-blue-800 mb-3">A - Airway</h3>
                    <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-3">
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airway_type" value="Patent" checked class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition border border-transparent">Patent</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airway_type" value="iGel/LMA" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition border border-transparent">iGel</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="airway_type" value="ETT" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition border border-transparent">ETT</div></label>
                    </div>
                    <textarea id="airway_notes" rows="1" placeholder="Size, depth, cuff pressure..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-sky-400 border-y border-r border-slate-200">
                    <h3 class="text-lg font-bold text-sky-700 mb-3">B - Breathing</h3>
                    <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-3">
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Clear Bilat" checked class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition border border-transparent">Clear</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Wheeze" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition border border-transparent">Wheeze</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Creps" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition border border-transparent">Creps</div></label>
                        <label class="cursor-pointer flex-1 text-center"><input type="radio" name="breath_sounds" value="Silent/Reduced" class="sr-only toggle-radio peer"><div class="px-2 py-2 rounded text-xs font-bold transition border border-transparent">Silent</div></label>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="section-label">RR</label><input type="number" id="breathing_rr" class="text-center font-mono font-bold"></div>
                        <div><label class="section-label">Sats (%)</label><input type="number" id="breathing_sats" class="text-center font-mono font-bold"></div>
                        <div><label class="section-label">EtCO2</label><input type="number" id="breathing_etco2" class="text-center font-mono font-bold" placeholder="kPa"></div>
                    </div>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-red-500 border-y border-r border-slate-200">
                    <h3 class="text-lg font-bold text-red-700 mb-3">C - Circulation</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        <div><label class="section-label">HR</label><input type="number" id="circ_hr" class="text-center font-mono font-bold"></div>
                        <div><label class="section-label">BP</label><input type="text" id="circ_bp" class="text-center font-mono font-bold" placeholder="120/80"></div>
                        <div><label class="section-label">MAP</label><input type="number" id="circ_map" class="text-center font-mono font-bold"></div>
                        <div><label class="section-label">Temp</label><input type="number" id="circ_temp" class="text-center font-mono font-bold"></div>
                    </div>
                    <textarea id="circ_notes" rows="1" placeholder="Peripheries, support requirements..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-yellow-400 border-y border-r border-slate-200">
                    <h3 class="text-lg font-bold text-yellow-700 mb-3">D - Disability</h3>
                    
                    <div class="grid grid-cols-3 gap-3 mb-3">
                         <div><label class="section-label">Eyes</label><select id="disability_gcsE"></select></div>
                         <div><label class="section-label">Verbal</label><select id="disability_gcsV"></select></div>
                         <div><label class="section-label">Motor</label><select id="disability_gcsM"></select></div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="section-label">Pupils</label>
                            <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-2">
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupils_equal" value="Equal" checked class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition border border-transparent">Equal</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupils_equal" value="Unequal" class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition border border-transparent">Unequal</div></label>
                            </div>
                            <input type="text" id="disability_pupils_size" placeholder="Size (e.g. 3mm)">
                        </div>
                        <div>
                            <label class="section-label">Reactivity</label>
                            <div class="flex rounded-md shadow-sm bg-slate-100 p-1 mb-2">
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupilReactivity" value="Yes" class="sr-only toggle-radio peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition border border-transparent">Reactive</div></label>
                                <label class="cursor-pointer flex-1 text-center"><input type="radio" name="pupilReactivity" value="None" checked class="sr-only toggle-radio-red peer"><div class="px-2 py-1.5 rounded text-xs font-bold transition border border-transparent text-red-600">Fixed/None</div></label>
                            </div>
                            <div class="relative">
                                <input type="number" id="disability_glucose" placeholder="Glucose">
                                <span class="absolute right-3 top-2 text-xs font-bold text-slate-400">mmol/L</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-green-500 border-y border-r border-slate-200">
                    <h3 class="text-lg font-bold text-green-700 mb-3">E - Exposure</h3>
                    <textarea id="exposure_notes" rows="1" placeholder="Trauma check, lines, rashes..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-yellow-500 border-y border-r border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 mb-3">Suspected Cause(s) of Arrest</h2>
                    <div id="reversibles" class="flex flex-wrap gap-2 mb-3"></div>
                    <textarea id="reversibles_notes" rows="1" placeholder="Details..."></textarea>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-purple-600 border-y border-r border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                         <h3 class="text-lg font-bold text-purple-700">Blood Gas</h3>
                         <div class="flex rounded-md shadow-sm bg-slate-100 p-1">
                            <label class="cursor-pointer flex-1"><input type="radio" name="gas_type" value="VBG" checked class="sr-only toggle-radio peer"><div class="px-3 py-1 rounded text-xs font-bold transition border border-transparent">VBG</div></label>
                            <label class="cursor-pointer flex-1"><input type="radio" name="gas_type" value="ABG" class="sr-only toggle-radio peer"><div class="px-3 py-1 rounded text-xs font-bold transition border border-transparent">ABG</div></label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div><label class="section-label">FiO2</label><input type="text" id="gas_fio2" placeholder="% or Flow"></div>
                        <div class="border-l-4 border-red-500 pl-2 rounded"><label class="section-label text-red-600">pH</label><input type="number" step="0.01" id="gas_ph" class="font-mono font-bold"></div>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
                        <div><label class="section-label">pCO2</label><input type="number" step="0.1" id="gas_pco2" class="text-center font-mono"></div>
                        <div><label class="section-label">pO2</label><input type="number" step="0.1" id="gas_po2" class="text-center font-mono"></div>
                        <div><label class="section-label">HCO3</label><input type="number" step="0.1" id="gas_hco3" class="text-center font-mono"></div>
                        <div><label class="section-label">BE</label><input type="number" step="0.1" id="gas_be" class="text-center font-mono"></div>
                        <div><label class="section-label text-purple-700">Lac</label><input type="number" step="0.1" id="gas_lactate" class="text-center font-mono font-bold text-purple-700 border-purple-200"></div>
                        <div><label class="section-label">K+</label><input type="number" step="0.1" id="gas_k" class="text-center font-mono"></div>
                    </div>
                </section>

                <section class="bg-red-50 p-5 rounded-lg shadow-sm border-2 border-red-200">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold text-red-900">MIRACLE² Score</h2>
                        <div class="text-right bg-white px-4 py-2 rounded-lg border border-red-100 shadow-sm">
                             <span id="miracle2_score" class="text-2xl font-black text-red-600 block leading-none">0</span>
                             <span id="miracle2_outcome" class="text-[10px] font-bold text-slate-500 block">~3% Risk</span>
                        </div>
                    </div>
                    
                    <div id="miracle2_inputs" class="space-y-2 mb-3 text-sm">
                        </div>
                    <p class="text-[10px] text-slate-500 text-center uppercase font-bold mt-4">Manual overrides enabled for all fields</p>
                </section>

                <section class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 border-t-4 border-t-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800">Plan</h2>
                        <a href="https://www.resus.org.uk/sites/default/files/2025-10/Adult%20post-resuscitation%20care%202025.pdf" target="_blank" class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center">
                            RCUK 2025 Bundle
                            <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <h4 class="text-xs font-black text-blue-900 uppercase mb-2">Post-ROSC Care Bundle</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3">
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600 rounded" value="SpO2 94-98%"><span class="text-xs font-bold text-slate-700">SpO2 94-98%</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600 rounded" value="Normocapnia"><span class="text-xs font-bold text-slate-700">Normocapnia</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600 rounded" value="12 Lead ECG"><span class="text-xs font-bold text-slate-700">12 Lead ECG</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600 rounded" value="Temp 32-36C"><span class="text-xs font-bold text-slate-700">Temp 32-36°C</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600 rounded" value="MAP > 65"><span class="text-xs font-bold text-slate-700">MAP > 65</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600 rounded" value="Glucose Control"><span class="text-xs font-bold text-slate-700">Glucose Control</span></label>
                        </div>
                        <button id="addBundleBtn" class="w-full py-1.5 bg-blue-600 text-white text-xs font-bold rounded hover:bg-blue-700 transition">Add Checked Items to Plan</button>
                    </div>
                    
                    <div class="space-y-3">
                        <div><label class="section-label">ECG / Imaging</label><textarea id="plan_ecg" rows="1" placeholder="Findings..."></textarea></div>
                        <div><label class="section-label">Immediate Management</label><textarea id="plan_management" rows="3" placeholder="Referrals, Drugs, Transfers..."></textarea></div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between">
                         <span class="text-sm font-bold text-slate-700">For Further Resuscitation?</span>
                         <div class="flex rounded-md shadow-sm bg-slate-100 p-1">
                            <label class="cursor-pointer"><input type="radio" name="further_resus" value="Yes" checked class="sr-only toggle-radio-green peer"><div class="px-4 py-1 rounded text-xs font-bold transition border border-transparent">YES</div></label>
                            <label class="cursor-pointer"><input type="radio" name="further_resus" value="No" class="sr-only toggle-radio-red peer"><div class="px-4 py-1 rounded text-xs font-bold transition border border-transparent">NO</div></label>
                        </div>
                    </div>
                </section>
                
                 <button id="clearForm" class="w-full py-3 text-red-600 bg-white hover:bg-red-50 font-bold rounded-lg transition-colors border border-slate-200 shadow-sm mt-4">
                    Clear All Data
                </button>

            </div>

            <div class="lg:col-span-5 xl:col-span-4 relative">
                <div class="sticky top-4 h-[calc(100vh-100px)]">
                    <section class="bg-white rounded-lg shadow-lg border border-slate-200 h-full flex flex-col">
                        <div class="flex justify-between items-center p-3 border-b border-slate-100 shrink-0">
                            <h2 class="text-xs font-bold text-slate-700 uppercase tracking-wide">Generated Note</h2>
                            <button id="copySummary" class="px-3 py-1 text-xs font-bold bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow-sm">COPY</button>
                        </div>
                        <textarea readonly id="summaryNoteOutput" class="w-full flex-grow p-3 bg-slate-50 text-xs font-mono text-slate-600 whitespace-pre-wrap focus:outline-none resize-none"></textarea>
                        <div class="p-2 border-t border-slate-100 text-[10px] text-slate-400 text-center">
                            &copy; 2025 Dr Jake Turner. WMEBEM.
                        </div>
                    </section>
                </div>
            </div>

        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const patientData = {
                age: '', patientDetails: '',
                witnessStatus: 'Unwitnessed', bystanderCPR: false,
                prearrest: { history: '', interventions: '' },
                arrestOnArrival: false, roscAchieved: false, rearrested: false,
                timeline: { collapse: '', cpr: '', defib: '', rosc: '', downtime: '' },
                rhythms: [], shocks: '', prehospital_drugs: '',
                postROSC: {
                    airway: { type: 'Patent', notes: '' },
                    breathing: { rr: '', sats: '', etco2: '', sounds: 'Clear Bilat' },
                    circulation: { hr: '', bp: '', map: '', temp: '', notes: '' },
                    disability: { gcsE: 1, gcsV: 1, gcsM: 1, pupilsEq: 'Equal', pupilsSize: '', pupilReactivity: 'None', glucose: '' },
                    exposure: '',
                },
                reversibles: { checked: [], notes: '' },
                bloodGas: { type: 'VBG', fio2: '', ph: '', pco2: '', po2: '', hco3: '', be: '', lactate: '', k: '' },
                miracle2: {
                    score: 0,
                    // null = auto, 1/0 = manual
                    missed: 1, nonShockable: 0, pupilReactivity: 1, age: 0, phLow: 0, 
                    changingRhythms: 0, adrenaline: 0
                },
                plan: { ecg: '', management: '', furtherResus: 'Yes' }
            };

            const RHYTHMS = ['VF', 'pVT', 'PEA', 'Asystole'];
            const REVERSIBLES = ['Hypoxia', 'Hypovolaemia', 'Hypo/HyperK+', 'Hypothermia', 'Thrombosis', 'Tamponade', 'Toxins', 'Tension PTX'];
            const MIRACLE2_OUTCOMES = { 0: '~3%', 1: '~6%', 2: '~15%', 3: '~30%', 4: '~50%', 5: '~70%', 6: '~85%', 7: '~95%', 8: '~98%', 9: '~99%', 10: '>99%' };
            
            const getEl = (id) => document.getElementById(id);

            // --- NOTE GENERATION ---
            function updateNotes() {
                const d = new Date();
                const timestamp = `${d.getDate()}/${d.getMonth()+1} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                
                let n = `*** CARDIAC ARREST PROFORMA ***\nDoc: ${timestamp}\n\n`;
                
                n += `ID: ${patientData.patientDetails || 'Unknown'} | Age: ${patientData.age || '?'}\n`;
                n += `Witnessed: ${patientData.witnessStatus} | Bystander CPR: ${patientData.bystanderCPR?'YES':'No'}\n`;
                n += `Hx: ${patientData.prearrest.history || '-'}\nRx: ${patientData.prearrest.interventions || '-'}\n\n`;
                
                n += `--- EVENTS ---\n`;
                n += `Arrest on Arrival: ${patientData.arrestOnArrival?'YES':'No'} | Pre-Hosp ROSC: ${patientData.roscAchieved?'YES':'No'}\n`;
                if(patientData.rearrested) n += `!!! PATIENT RE-ARRESTED POST-ROSC !!!\n`;
                
                if(patientData.arrestOnArrival || patientData.roscAchieved) {
                    const t = patientData.timeline;
                    n += `Times: Col ${t.collapse||'-'} / CPR ${t.cpr||'-'} / Defib ${t.defib||'-'} / ROSC ${t.rosc||'-'}\n`;
                    n += `Total Downtime: ${t.downtime || '?'} mins\n`;
                    n += `Rhythms: ${patientData.rhythms.join(', ') || '-'}\n`;
                    n += `Shocks: ${patientData.shocks||'0'} | Drugs: ${patientData.prehospital_drugs||'-'}\n`;
                }
                
                n += `\n--- POST-ROSC ---\n`;
                const pr = patientData.postROSC;
                n += `A: ${pr.airway.type}. ${pr.airway.notes}\n`;
                n += `B: ${pr.breathing.sounds}. RR ${pr.breathing.rr||'-'} Sats ${pr.breathing.sats||'-'}% EtCO2 ${pr.breathing.etco2||'-'}\n`;
                n += `C: HR ${pr.circulation.hr||'-'} BP ${pr.circulation.bp||'-'} MAP ${pr.circulation.map||'-'} T ${pr.circulation.temp||'-'}. ${pr.circulation.notes}\n`;
                
                const gcs = parseInt(pr.disability.gcsE)+parseInt(pr.disability.gcsV)+parseInt(pr.disability.gcsM);
                n += `D: GCS ${gcs} (E${pr.disability.gcsE}V${pr.disability.gcsV}M${pr.disability.gcsM}). Pupils: ${pr.disability.pupilsEq} ${pr.disability.pupilsSize} (${pr.disability.pupilReactivity}). BM ${pr.disability.glucose||'-'}\n`;
                n += `E: ${pr.exposure||'-'}\n`;
                
                n += `\nCauses Considered: ${patientData.reversibles.checked.join(', ') || 'None selected'}. ${patientData.reversibles.notes}\n`;
                
                const gas = patientData.bloodGas;
                n += `Gas (${gas.type}): FiO2 ${gas.fio2||'-'} | pH ${gas.ph} | pCO2 ${gas.pco2} | pO2 ${gas.po2} | Lac ${gas.lactate} | K ${gas.k}\n`;
                
                const m2 = patientData.miracle2;
                n += `\nMIRACLE² Score: ${m2.score} (${MIRACLE2_OUTCOMES[m2.score] || '?'})\n`;
                
                n += `\n--- PLAN ---\n`;
                n += `Further Resus: ${patientData.plan.furtherResus.toUpperCase()}\n`;
                n += `ECG/Img: ${patientData.plan.ecg||'-'}\n`;
                n += `Mgmt: ${patientData.plan.management||'-'}`;
                
                getEl('summaryNoteOutput').value = n;
            }

            // --- CALCULATORS ---
            function calcDowntime() {
                const c = getEl('time_collapse').value;
                const r = getEl('time_rosc').value;
                if(c && r) {
                    const d1 = new Date(`1970-01-01T${c}:00`);
                    const d2 = new Date(`1970-01-01T${r}:00`);
                    if(d2 < d1) d2.setDate(d2.getDate()+1);
                    const diff = Math.round((d2-d1)/60000);
                    patientData.timeline.downtime = diff;
                    getEl('downtime').value = diff;
                }
            }

            function calcMiracle2() {
                const m = patientData.miracle2;
                m.score = m.missed + m.nonShockable + m.pupilReactivity + m.age + m.changingRhythms + m.phLow + (m.adrenaline * 2);
                getEl('miracle2_score').textContent = m.score;
                getEl('miracle2_outcome').textContent = MIRACLE2_OUTCOMES[m.score] || '?';
                updateNotes();
            }

            // --- INIT ---
            function init() {
                // Generate Checkboxes
                const mkCheck = (val, id) => `<label class="cursor-pointer flex items-center space-x-2 p-1.5 border border-slate-200 rounded hover:bg-slate-50 transition"><input type="checkbox" value="${val}" class="${id} w-4 h-4 text-blue-600 rounded border-slate-300"> <span class="text-xs font-bold text-slate-700">${val}</span></label>`;
                
                getEl('initialRhythm').innerHTML = RHYTHMS.map(r => mkCheck(r, 'rhythm-check')).join('');
                getEl('reversibles').innerHTML = REVERSIBLES.map(r => mkCheck(r, 'rev-check')).join('');

                // Generate Miracle 2 Rows with Manual Override
                const m2Con = getEl('miracle2_inputs');
                const m2Items = [
                    { id: 'missed', label: 'Unwitnessed' },
                    { id: 'nonShockable', label: 'Non-shockable Rhythm' },
                    { id: 'pupilReactivity', label: 'No Pupil Reactivity' },
                    { id: 'phLow', label: 'pH < 7.20' },
                    { id: 'changingRhythms', label: 'Changing Rhythms (≥2)' },
                    { id: 'adrenaline', label: 'Epinephrine Given' }
                ];
                
                m2Items.forEach(i => {
                    m2Con.innerHTML += `
                    <div class="flex justify-between items-center border-b border-red-100 pb-2 last:border-0">
                        <span class="text-xs font-bold text-slate-700">${i.label}</span>
                        <div class="flex space-x-1">
                            <label class="cursor-pointer"><input type="radio" name="m2_${i.id}" value="1" class="sr-only peer"><span class="px-2 py-0.5 rounded text-[10px] font-bold border border-slate-300 bg-white text-slate-400 peer-checked:bg-red-100 peer-checked:text-red-700 peer-checked:border-red-300 hover:bg-slate-50">YES</span></label>
                            <label class="cursor-pointer"><input type="radio" name="m2_${i.id}" value="0" class="sr-only peer"><span class="px-2 py-0.5 rounded text-[10px] font-bold border border-slate-300 bg-white text-slate-400 peer-checked:bg-slate-200 peer-checked:text-slate-700 peer-checked:border-slate-300 hover:bg-slate-50">NO</span></label>
                        </div>
                    </div>`;
                });
                // Age is special
                m2Con.innerHTML += `<div class="flex justify-between items-center pt-1 border-t border-red-100 mt-2"><span class="text-xs font-bold text-slate-700">Age Points (0, 1, 3)</span><span id="m2_age_disp" class="text-xs font-black text-slate-400 bg-slate-100 px-2 py-1 rounded">0</span></div>`;
                
                // Set default M2 radios
                m2Items.forEach(i => {
                    const def = patientData.miracle2[i.id];
                    document.querySelector(`input[name="m2_${i.id}"][value="${def}"]`).checked = true;
                });

                // GCS Dropdowns
                const popSel = (id, max) => {
                    const s = getEl(id);
                    for(let i=max; i>=1; i--) s.add(new Option(i,i));
                };
                popSel('disability_gcsE', 4); popSel('disability_gcsV', 5); popSel('disability_gcsM', 6);

                setupListeners();
                updateNotes();
            }

            // --- LISTENERS ---
            function setupListeners() {
                // Re-arrest Toggle logic
                const ar = getEl('arrestOnArrival');
                const ro = getEl('roscAchieved');
                const rearrestCont = getEl('rearrestContainer');
                
                const toggleTimeline = () => {
                     const show = ar.checked || ro.checked;
                     getEl('timeline_inputs').classList.toggle('hidden', !show);
                     patientData.arrestOnArrival = ar.checked;
                     patientData.roscAchieved = ro.checked;
                     
                     // Logic: Only show re-arrest if ROSC was achieved
                     if(ro.checked) rearrestCont.classList.remove('hidden');
                     else {
                        rearrestCont.classList.add('hidden');
                        patientData.rearrested = false;
                        getEl('rearrested').checked = false;
                     }
                     updateNotes();
                };
                ar.addEventListener('change', toggleTimeline);
                ro.addEventListener('change', toggleTimeline);
                
                getEl('rearrested').addEventListener('change', e => { patientData.rearrested = e.target.checked; updateNotes(); });

                // Auto-updates for Miracle 2
                const setM2 = (key, val) => {
                    patientData.miracle2[key] = val;
                    document.querySelector(`input[name="m2_${key}"][value="${val}"]`).checked = true;
                    calcMiracle2();
                };

                getEl('age').addEventListener('input', e => {
                    const v = parseInt(e.target.value);
                    patientData.age = v;
                    let p = 0; if(v>80) p=3; else if(v>=60) p=1;
                    patientData.miracle2.age = p;
                    getEl('m2_age_disp').textContent = p;
                    calcMiracle2();
                });

                getEl('witness_status').addEventListener('change', e => {
                    patientData.witnessStatus = e.target.value;
                    setM2('missed', e.target.value === 'Unwitnessed' ? 1 : 0);
                    updateNotes();
                });

                getEl('gas_ph').addEventListener('input', e => {
                    patientData.bloodGas.ph = e.target.value;
                    if(e.target.value && parseFloat(e.target.value) < 7.20) setM2('phLow', 1); else setM2('phLow', 0);
                    updateNotes();
                });

                // Rhythm Checkbox logic
                document.body.addEventListener('change', e => {
                    if(e.target.classList.contains('rhythm-check')) {
                        const val = e.target.value;
                        if(e.target.checked) patientData.rhythms.push(val); 
                        else patientData.rhythms = patientData.rhythms.filter(x=>x!==val);
                        
                        const nonShock = patientData.rhythms.some(r=>['PEA','Asystole'].includes(r)) && !patientData.rhythms.some(r=>['VF','pVT'].includes(r));
                        setM2('nonShockable', nonShock ? 1 : 0);
                        updateNotes();
                    }
                });

                document.querySelectorAll('input[name="pupilReactivity"]').forEach(el => el.addEventListener('change', e => {
                    patientData.postROSC.disability.pupilReactivity = e.target.value;
                    setM2('pupilReactivity', e.target.value === 'None' ? 1 : 0);
                    updateNotes();
                }));

                // Manual M2 overrides
                document.querySelectorAll('input[name^="m2_"]').forEach(el => {
                    el.addEventListener('change', e => {
                        const key = e.target.name.replace('m2_', '');
                        patientData.miracle2[key] = parseInt(e.target.value);
                        calcMiracle2();
                    });
                });

                // General Bindings
                const bind = (id, root, key) => {
                    getEl(id).addEventListener('input', e => { root[key] = e.target.value; updateNotes(); });
                };
                bind('patient_details', patientData, 'patientDetails');
                bind('prearrest_history', patientData.prearrest, 'history');
                bind('prearrest_interventions', patientData.prearrest, 'interventions');
                bind('time_collapse', patientData.timeline, 'collapse');
                bind('time_cpr', patientData.timeline, 'cpr');
                bind('time_defib', patientData.timeline, 'defib');
                bind('time_rosc', patientData.timeline, 'rosc');
                bind('shocks', patientData, 'shocks');
                bind('prehospital_drugs', patientData, 'prehospital_drugs');
                bind('airway_notes', patientData.postROSC.airway, 'notes');
                bind('breathing_rr', patientData.postROSC.breathing, 'rr');
                bind('breathing_sats', patientData.postROSC.breathing, 'sats');
                bind('breathing_etco2', patientData.postROSC.breathing, 'etco2');
                bind('circ_hr', patientData.postROSC.circulation, 'hr');
                bind('circ_bp', patientData.postROSC.circulation, 'bp');
                bind('circ_map', patientData.postROSC.circulation, 'map');
                bind('circ_temp', patientData.postROSC.circulation, 'temp');
                bind('circ_notes', patientData.postROSC.circulation, 'notes');
                bind('disability_gcsE', patientData.postROSC.disability, 'gcsE'); 
                bind('disability_gcsV', patientData.postROSC.disability, 'gcsV');
                bind('disability_gcsM', patientData.postROSC.disability, 'gcsM');
                bind('disability_pupils_size', patientData.postROSC.disability, 'pupilsSize');
                bind('disability_glucose', patientData.postROSC.disability, 'glucose');
                bind('exposure_notes', patientData.postROSC, 'exposure');
                bind('reversibles_notes', patientData.reversibles, 'notes');
                bind('gas_fio2', patientData.bloodGas, 'fio2');
                bind('gas_pco2', patientData.bloodGas, 'pco2');
                bind('gas_po2', patientData.bloodGas, 'po2');
                bind('gas_hco3', patientData.bloodGas, 'hco3');
                bind('gas_be', patientData.bloodGas, 'be');
                bind('gas_lactate', patientData.bloodGas, 'lactate');
                bind('gas_k', patientData.bloodGas, 'k');
                bind('plan_ecg', patientData.plan, 'ecg');
                bind('plan_management', patientData.plan, 'management');

                // Time calc trigger
                ['time_collapse', 'time_rosc'].forEach(id => getEl(id).addEventListener('input', calcDowntime));

                // Button Groups (Radios)
                document.querySelectorAll('input[name="airway_type"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.airway.type = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="breath_sounds"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.breathing.sounds = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="pupils_equal"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.disability.pupilsEq = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="gas_type"]').forEach(r => r.addEventListener('change', e => { patientData.bloodGas.type = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="further_resus"]').forEach(r => r.addEventListener('change', e => { patientData.plan.furtherResus = e.target.value; updateNotes(); }));

                // Reversibles Checks
                document.body.addEventListener('change', e => {
                    if(e.target.classList.contains('rev-check')) {
                        const v = e.target.value;
                        if(e.target.checked) patientData.reversibles.checked.push(v);
                        else patientData.reversibles.checked = patientData.reversibles.checked.filter(x=>x!==v);
                        updateNotes();
                    }
                });
                
                // Add Bundle to Plan
                getEl('addBundleBtn').addEventListener('click', () => {
                    const checked = Array.from(document.querySelectorAll('.bundle-check:checked')).map(c => c.value);
                    if(checked.length > 0) {
                        const current = getEl('plan_management').value;
                        const addition = "RCUK 2025 Care Bundle: " + checked.join(', ');
                        getEl('plan_management').value = current ? current + "\n" + addition : addition;
                        patientData.plan.management = getEl('plan_management').value;
                        updateNotes();
                    }
                });

                // Clear & Copy
                getEl('clearForm').addEventListener('click', () => { if(confirm('Reset all data?')) location.reload(); });
                getEl('copySummary').addEventListener('click', () => { navigator.clipboard.writeText(getEl('summaryNoteOutput').value); alert('Copied!'); });
            }

            init();
        });
    </script>
</body>
</html>
