<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cardiac Arrest & ROSC Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        nhs: { blue: '#005EB8', dark: '#003087', bright: '#0072CE' }
                    }
                }
            }
        }
    </script>
    <style>
        /* Base Polish */
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        /* High Contrast Inputs */
        textarea { resize: none; overflow: hidden; min-height: 2.5rem; transition: height 0.1s ease; }
        .input-field { 
            @apply w-full px-3 py-2.5 bg-white border-2 border-slate-300 rounded-lg text-slate-900 text-sm font-medium focus:ring-2 focus:ring-nhs-blue focus:border-nhs-blue transition-all outline-none shadow-sm placeholder:text-slate-400; 
        }
        .input-label { @apply block text-xs uppercase tracking-wider font-bold text-slate-600 mb-1.5; }
        
        /* Card Styling */
        .card { @apply bg-white p-5 rounded-xl shadow-md border border-slate-300 transition-all duration-200; }
        .card-header { @apply flex items-center border-b-2 border-slate-100 pb-3 mb-5; }
        .card-title { @apply text-lg font-bold text-slate-900 tracking-tight; }
        
        /* Button Groups */
        .btn-group-label { @apply cursor-pointer flex-1 text-center select-none; }
        .btn-group-input { @apply sr-only peer; }
        .btn-group-item { @apply block w-full px-2 py-2 text-xs font-bold border-y-2 border-r-2 border-slate-300 bg-slate-50 text-slate-600 hover:bg-slate-100 peer-checked:bg-nhs-blue peer-checked:text-white peer-checked:border-nhs-blue transition-all; }
        .btn-group-first { @apply rounded-l-lg border-l-2; }
        .btn-group-last { @apply rounded-r-lg; }

        /* Miracle 2 Highlight */
        .m2-source { @apply border-l-4 border-l-red-500 pl-3 -ml-3 rounded-l; }

        /* Utility */
        .input-suffix-group { @apply relative flex items-center; }
        .input-suffix { @apply absolute right-3 text-xs font-bold text-slate-500 pointer-events-none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }

        /* Mobile Tabs */
        .tab-btn { @apply flex-1 py-4 text-sm font-bold text-center border-b-4 transition-colors; }
        .tab-active { @apply border-nhs-blue text-nhs-blue bg-blue-50; }
        .tab-inactive { @apply border-transparent text-slate-500 hover:text-slate-700 bg-white; }
    </style>
</head>
<body class="bg-slate-200 text-slate-900 h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-slate-300 shadow-md z-40 relative">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center gap-4">
                <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-10 w-auto object-contain">
                <div>
                    <h1 class="text-xl font-black text-nhs-blue tracking-tight leading-none uppercase">Cardiac Arrest</h1>
                    <p class="text-[10px] sm:text-xs text-slate-500 font-bold uppercase tracking-wide mt-0.5">Documentation Tool</p>
                </div>
            </div>
            <div class="hidden sm:block text-right">
                <p class="text-[10px] text-slate-400 font-bold uppercase">Designed by</p>
                <p class="text-xs font-bold text-slate-700">Dr Jake Turner</p>
            </div>
        </div>
    </header>

    <div class="lg:hidden flex bg-white border-b border-slate-300 shadow-sm z-30">
        <button id="tabForm" class="tab-btn tab-active">Input Data</button>
        <button id="tabSummary" class="tab-btn tab-inactive">Generated Note</button>
    </div>

    <main class="flex-grow container mx-auto px-2 sm:px-4 py-4 sm:py-6 overflow-hidden max-w-7xl">
        <div class="h-full grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div id="inputColumn" class="lg:col-span-7 h-full overflow-y-auto custom-scroll pb-32 pr-2">
                
                <div class="space-y-6">

                    <section class="card border-t-4 border-t-blue-600">
                        <div class="card-header">
                            <h2 class="card-title text-slate-800">Pre-Hospital Handover</h2>
                        </div>
                        
                        <div class="grid grid-cols-4 sm:grid-cols-12 gap-4 mb-5">
                             <div class="col-span-1 sm:col-span-3 m2-source">
                                <label for="age" class="input-label">Age</label>
                                <input type="number" id="age" class="input-field text-center font-bold text-lg" placeholder="--">
                            </div>
                            <div class="col-span-3 sm:col-span-9">
                                <label for="patient_details" class="input-label">Patient ID / Details</label>
                                <input type="text" id="patient_details" class="input-field" placeholder="Name, DOB, Hospital No.">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5 bg-slate-100 p-4 rounded-xl border border-slate-200">
                            <div class="m2-source">
                                <label for="witness_status" class="input-label">Witnessed Status</label>
                                <div class="relative">
                                    <select id="witness_status" class="input-field appearance-none cursor-pointer font-bold">
                                        <option value="Unwitnessed">Unwitnessed</option>
                                        <option value="Bystander">Bystander Witnessed</option>
                                        <option value="Paramedic">Paramedic Witnessed</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-500">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center w-full p-3 bg-white border-2 border-slate-300 rounded-lg cursor-pointer hover:border-blue-400 transition-colors shadow-sm">
                                    <input type="checkbox" id="bystander_cpr" class="w-5 h-5 rounded border-slate-400 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-3 font-bold text-slate-700">Bystander CPR?</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div><label class="input-label">History / PC</label><textarea id="prearrest_history" class="input-field" placeholder="e.g. Complained of chest pain..."></textarea></div>
                            <div><label class="input-label">Pre-Arrest Interventions</label><textarea id="prearrest_interventions" class="input-field" placeholder="e.g. Aspirin 300mg, GTN..."></textarea></div>
                        </div>

                        <div class="grid grid-cols-1 gap-3 mt-6 pt-5 border-t-2 border-slate-100">
                            <div class="flex gap-4">
                                <label class="flex-1 flex flex-col items-center justify-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:bg-red-50 transition-all has-[:checked]:border-red-600 has-[:checked]:bg-red-50">
                                    <span class="text-xs font-black text-slate-600 mb-1 uppercase">Arrest on Arrival?</span>
                                    <input type="checkbox" id="arrestOnArrival" class="w-5 h-5 text-red-600 rounded focus:ring-red-500 border-slate-400">
                                </label>
                                <label class="flex-1 flex flex-col items-center justify-center p-3 border-2 border-slate-300 rounded-lg cursor-pointer hover:bg-green-50 transition-all has-[:checked]:border-green-600 has-[:checked]:bg-green-50">
                                    <span class="text-xs font-black text-slate-600 mb-1 uppercase">ROSC Achieved?</span>
                                    <input type="checkbox" id="roscAchieved" class="w-5 h-5 text-green-600 rounded focus:ring-green-500 border-slate-400">
                                </label>
                            </div>
                            <label class="flex items-center justify-between p-3 bg-red-100 border-2 border-red-300 rounded-lg cursor-pointer hover:bg-red-200 transition-colors hidden" id="rearrestContainer">
                                <span class="font-bold text-red-800 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                    Patient Re-arrested Post-ROSC?
                                </span>
                                <input type="checkbox" id="rearrested" class="w-6 h-6 text-red-700 rounded focus:ring-red-600 border-red-400">
                            </label>
                        </div>

                        <div id="timeline_details" class="hidden mt-6 bg-blue-50/80 rounded-xl p-5 border-2 border-blue-200">
                            <h3 class="font-bold text-blue-900 mb-4 text-sm uppercase tracking-wider">Arrest Timeline</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                                <div><label class="input-label text-blue-800">Collapse</label><input type="time" id="time_collapse" class="input-field border-blue-200"></div>
                                <div><label class="input-label text-blue-800">1st CPR</label><input type="time" id="time_cpr" class="input-field border-blue-200"></div>
                                <div><label class="input-label text-blue-800">1st Defib</label><input type="time" id="time_defib" class="input-field border-blue-200"></div>
                                <div><label class="input-label text-blue-800">ROSC</label><input type="time" id="time_rosc" class="input-field border-blue-200"></div>
                            </div>
                             <div class="mb-4">
                                <label for="downtime" class="input-label text-blue-800">Total Downtime</label>
                                <div class="input-suffix-group">
                                    <input type="number" id="downtime" class="input-field font-black text-slate-800 bg-white" readonly>
                                    <span class="input-suffix">mins</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="m2-source">
                                    <label class="input-label text-blue-800">Initial Rhythm(s)</label>
                                    <div id="initialRhythm" class="space-y-2 bg-white p-3 rounded-lg border-2 border-blue-200"></div>
                                </div>
                                <div>
                                    <label for="shocks" class="input-label text-blue-800">Shocks</label>
                                    <input type="number" id="shocks" class="input-field border-blue-200">
                                    <div class="mt-3 m2-source">
                                        <label class="input-label text-blue-800">Arrest Drugs</label>
                                        <textarea id="prehospital_drugs" class="input-field border-blue-200" placeholder="e.g. Adrenaline x3"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="card border-t-4 border-t-green-600">
                        <div class="card-header">
                            <h2 class="card-title text-slate-800">Post-ROSC Assessment</h2>
                        </div>
                        
                        <div class="mb-8 p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <h3 class="text-sm font-black text-slate-700 uppercase mb-3">A - Airway</h3>
                            <div class="flex rounded-lg shadow-sm mb-3">
                                <label class="btn-group-label"><input type="radio" name="airway_type" value="Patent" class="btn-group-input"><span class="btn-group-item btn-group-first">Patent</span></label>
                                <label class="btn-group-label"><input type="radio" name="airway_type" value="iGel/LMA" class="btn-group-input"><span class="btn-group-item">iGel</span></label>
                                <label class="btn-group-label"><input type="radio" name="airway_type" value="ETT" class="btn-group-input"><span class="btn-group-item btn-group-last">ETT</span></label>
                            </div>
                            <textarea id="airway_notes" class="input-field" placeholder="Size, depth, cuff pressure..."></textarea>
                        </div>

                        <div class="mb-8 p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <h3 class="text-sm font-black text-slate-700 uppercase mb-3">B - Breathing</h3>
                             <div class="flex rounded-lg shadow-sm mb-3">
                                <label class="btn-group-label"><input type="radio" name="breath_sounds" value="Clear Bilat" class="btn-group-input"><span class="btn-group-item btn-group-first">Clear</span></label>
                                <label class="btn-group-label"><input type="radio" name="breath_sounds" value="Wheeze" class="btn-group-input"><span class="btn-group-item">Wheeze</span></label>
                                <label class="btn-group-label"><input type="radio" name="breath_sounds" value="Creps" class="btn-group-input"><span class="btn-group-item">Creps</span></label>
                                <label class="btn-group-label"><input type="radio" name="breath_sounds" value="Silent/Reduced" class="btn-group-input"><span class="btn-group-item btn-group-last">Silent</span></label>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                <div><label class="input-label">RR</label><div class="input-suffix-group"><input type="number" id="breathing_rr" class="input-field text-center"><span class="input-suffix">/min</span></div></div>
                                <div><label class="input-label">Sats</label><div class="input-suffix-group"><input type="number" id="breathing_sats" class="input-field text-center"><span class="input-suffix">%</span></div></div>
                                <div><label class="input-label">EtCO2</label><div class="input-suffix-group"><input type="number" id="breathing_etco2" class="input-field text-center"><span class="input-suffix">kPa</span></div></div>
                            </div>
                        </div>

                        <div class="mb-8 p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <h3 class="text-sm font-black text-slate-700 uppercase mb-3">C - Circulation</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
                                <div><label class="input-label">HR</label><div class="input-suffix-group"><input type="number" id="circ_hr" class="input-field text-center"><span class="input-suffix">bpm</span></div></div>
                                <div><label class="input-label">BP</label><input type="text" id="circ_bp" class="input-field text-center" placeholder="120/80"></div>
                                <div><label class="input-label">MAP</label><div class="input-suffix-group"><input type="number" id="circ_map" class="input-field text-center"><span class="input-suffix">mmHg</span></div></div>
                                <div><label class="input-label">Temp</label><div class="input-suffix-group"><input type="number" id="circ_temp" class="input-field text-center"><span class="input-suffix">°C</span></div></div>
                            </div>
                            <textarea id="circ_notes" class="input-field" placeholder="Peripheries, support requirements..."></textarea>
                        </div>

                        <div class="mb-8 p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <h3 class="text-sm font-black text-slate-700 uppercase mb-3">D - Disability</h3>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <div><label class="input-label">Eyes</label><select id="disability_gcsE" class="input-field py-1.5"></select></div>
                                <div><label class="input-label">Verbal</label><select id="disability_gcsV" class="input-field py-1.5"></select></div>
                                <div><label class="input-label">Motor</label><select id="disability_gcsM" class="input-field py-1.5"></select></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-3 m2-source">
                                <div>
                                    <label class="input-label">Pupils</label>
                                    <div class="flex rounded-lg shadow-sm">
                                        <label class="btn-group-label"><input type="radio" name="pupils_equal" value="Equal" class="btn-group-input"><span class="btn-group-item btn-group-first">Equal</span></label>
                                        <label class="btn-group-label"><input type="radio" name="pupils_equal" value="Unequal" class="btn-group-input"><span class="btn-group-item btn-group-last">Unequal</span></label>
                                    </div>
                                    <input type="text" id="disability_pupils_size" class="input-field mt-2" placeholder="Size (e.g. 3mm)">
                                </div>
                                <div>
                                    <label class="input-label">Reactivity</label>
                                    <div class="flex rounded-lg shadow-sm">
                                        <label class="btn-group-label"><input type="radio" name="pupilReactivity" value="Yes" class="btn-group-input"><span class="btn-group-item btn-group-first">React</span></label>
                                        <label class="btn-group-label"><input type="radio" name="pupilReactivity" value="None" checked class="btn-group-input"><span class="btn-group-item btn-group-last text-red-600">None</span></label>
                                    </div>
                                    <div class="mt-2 relative"><input type="number" id="disability_glucose" class="input-field"><span class="absolute right-3 top-2.5 text-xs text-slate-500 font-bold">mmol/L</span></div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-black text-slate-700 uppercase mb-3">E - Exposure</h3>
                            <textarea id="exposure_notes" class="input-field" placeholder="Trauma check, lines, rashes..."></textarea>
                        </div>
                    </section>

                    <section class="card border-t-4 border-t-yellow-500">
                        <div class="card-header">
                            <h2 class="card-title text-slate-800">Suspected Cause(s) of Arrest</h2>
                        </div>
                        <div id="reversibles" class="grid grid-cols-2 gap-3 mb-4"></div>
                        <textarea id="reversibles_notes" class="input-field" placeholder="Additional notes..."></textarea>
                    </section>

                    <section class="card border-t-4 border-t-purple-600">
                        <div class="card-header justify-between">
                            <h2 class="card-title text-slate-800">Blood Gas</h2>
                            <div class="flex space-x-1 bg-slate-200 p-1 rounded-lg">
                                <label class="cursor-pointer px-4 py-1.5 rounded-md text-xs font-bold has-[:checked]:bg-white has-[:checked]:text-purple-700 has-[:checked]:shadow transition-all text-slate-500"><input type="radio" name="gas_type" value="VBG" checked class="hidden">VBG</label>
                                <label class="cursor-pointer px-4 py-1.5 rounded-md text-xs font-bold has-[:checked]:bg-white has-[:checked]:text-purple-700 has-[:checked]:shadow transition-all text-slate-500"><input type="radio" name="gas_type" value="ABG" class="hidden">ABG</label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="input-label">FiO2</label><input type="text" id="gas_fio2" class="input-field" placeholder="%"></div>
                            <div class="m2-source"><label class="input-label">pH</label><input type="number" step="0.01" id="gas_ph" class="input-field font-mono font-bold"></div>
                        </div>
                        <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
                            <div><label class="input-label">pCO2</label><input type="number" step="0.1" id="gas_pco2" class="input-field font-mono text-center"></div>
                            <div><label class="input-label">pO2</label><input type="number" step="0.1" id="gas_po2" class="input-field font-mono text-center"></div>
                            <div><label class="input-label">HCO3</label><input type="number" step="0.1" id="gas_hco3" class="input-field font-mono text-center"></div>
                            <div><label class="input-label">BE</label><input type="number" step="0.1" id="gas_be" class="input-field font-mono text-center"></div>
                            <div><label class="input-label text-purple-700">Lac</label><input type="number" step="0.1" id="gas_lactate" class="input-field font-mono text-center border-purple-200 text-purple-700 font-bold"></div>
                            <div><label class="input-label">K+</label><input type="number" step="0.1" id="gas_k" class="input-field font-mono text-center"></div>
                        </div>
                    </section>

                    <section class="card border-t-4 border-t-red-600 bg-red-50">
                        <div class="card-header border-red-200">
                            <h2 class="card-title text-red-900">MIRACLE² Score</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div id="miracle2_inputs" class="space-y-3">
                                </div>
                            <div class="flex flex-col justify-center items-center bg-white border-2 border-red-100 rounded-2xl p-6 shadow-sm">
                                <span class="text-xs font-bold text-red-400 uppercase tracking-widest mb-1">Risk Score</span>
                                <span id="miracle2_score" class="text-7xl font-black text-red-600 leading-none">0</span>
                                <div class="mt-4 text-center w-full">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Poor Neuro Outcome Probability</p>
                                    <p id="miracle2_outcome" class="text-xl font-bold text-slate-800 bg-slate-100 py-2 rounded-lg">~3%</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="card border-t-4 border-t-slate-800">
                        <div class="card-header justify-between">
                            <h2 class="card-title text-slate-800">Plan & Guidelines</h2>
                            <a href="https://www.resus.org.uk/sites/default/files/2025-10/Adult%20post-resuscitation%20care%202025.pdf" target="_blank" class="text-xs font-bold text-blue-600 hover:underline">Open RCUK 2025 Bundle &nearr;</a>
                        </div>
                        
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6">
                            <h3 class="font-black text-blue-900 text-sm uppercase mb-3">RCUK 2025 Care Bundle Checklist</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600" value="Target SpO2 94-98%"><span class="text-sm font-semibold text-blue-800">Target SpO2 94-98%</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600" value="Normocapnia (PaCO2 4.7-6.0)"><span class="text-sm font-semibold text-blue-800">Normocapnia</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600" value="12-Lead ECG Acquired"><span class="text-sm font-semibold text-blue-800">12-Lead ECG</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600" value="Temp Control (32-36°C / No Fever)"><span class="text-sm font-semibold text-blue-800">Temp Control</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600" value="Target MAP >65mmHg"><span class="text-sm font-semibold text-blue-800">Target MAP >65</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" class="bundle-check w-4 h-4 text-blue-600" value="Avoid Hypo/Hyperglycaemia"><span class="text-sm font-semibold text-blue-800">Glucose Control</span></label>
                            </div>
                            <button id="addBundleToPlan" class="mt-4 w-full py-2 bg-blue-600 text-white text-xs font-bold rounded hover:bg-blue-700 transition">Add Checklist to Plan</button>
                        </div>

                        <div class="space-y-4">
                            <div><label class="input-label">ECG / Imaging</label><textarea id="plan_ecg" class="input-field" placeholder="Findings..."></textarea></div>
                            <div><label class="input-label">Immediate Management</label><textarea id="plan_management" class="input-field" placeholder="Referrals, Drugs, Transfers..."></textarea></div>
                        </div>

                        <div class="mt-6 pt-4 border-t-2 border-slate-100 flex items-center justify-between">
                            <span class="font-bold text-slate-700">For further resuscitation?</span>
                            <div class="flex gap-4">
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="further_resus" value="Yes" checked class="text-green-600 focus:ring-green-500 w-5 h-5"><span class="font-bold">YES</span></label>
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="further_resus" value="No" class="text-red-600 focus:ring-red-500 w-5 h-5"><span class="font-bold">NO</span></label>
                            </div>
                        </div>
                    </section>

                    <div class="pt-6 pb-20 lg:pb-6">
                        <button id="clearForm" class="w-full py-4 text-red-600 bg-white hover:bg-red-50 font-bold rounded-xl border-2 border-slate-200 hover:border-red-200 shadow-sm flex items-center justify-center gap-2">
                            Reset Form
                        </button>
                    </div>

                </div>
            </div>

            <div id="outputColumn" class="hidden lg:block lg:col-span-5 h-full lg:h-[calc(100vh-100px)] lg:sticky lg:top-24">
                <div class="card h-full flex flex-col p-0 overflow-hidden bg-slate-800 border-slate-700 shadow-2xl rounded-xl">
                    <div class="px-5 py-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center shrink-0">
                        <h2 class="font-bold text-slate-100 uppercase tracking-wider text-sm">Generated Note</h2>
                        <button id="copySummary" class="px-3 py-1.5 text-xs font-bold bg-nhs-blue hover:bg-blue-600 text-white rounded transition-all shadow-lg">COPY</button>
                    </div>
                    <div class="relative flex-grow bg-slate-800">
                        <textarea readonly id="summaryNoteOutput" class="w-full h-full p-5 bg-slate-800 text-slate-200 font-mono text-sm leading-relaxed resize-none focus:outline-none custom-scroll"></textarea>
                    </div>
                    <div class="px-4 py-2 bg-slate-900 text-[10px] text-slate-500 text-center shrink-0">
                        &copy; 2025 Dr Jake Turner. WMEBEM.
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="lg:hidden bg-slate-900 text-slate-400 text-center py-4 text-xs font-bold">
        &copy; 2025 Dr Jake Turner
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const patientData = {
                age: '', patientDetails: '',
                witnessStatus: 'Unwitnessed', bystanderCPR: false,
                prearrest: { history: '', interventions: '' },
                arrestOnArrival: false, roscAchieved: false, rearrested: false,
                timeline: { collapse: '', cpr: '', defib: '', rosc: '', downtime: '' },
                rhythms: [], shocks: '', prehospital_drugs: '',
                postROSC: {
                    airway: { type: 'Patent', notes: '' },
                    breathing: { rr: '', sats: '', etco2: '', sounds: 'Clear Bilat' },
                    circulation: { hr: '', bp: '', map: '', temp: '', notes: '' },
                    disability: { gcsE: 1, gcsV: 1, gcsM: 1, pupilsEq: 'Equal', pupilsSize: '', pupilReactivity: 'None', glucose: '' },
                    exposure: '',
                },
                reversibles: { checked: [], notes: '' },
                bloodGas: { type: 'VBG', fio2: '', ph: '', pco2: '', po2: '', hco3: '', be: '', lactate: '', k: '' },
                miracle2: {
                    score: 0,
                    // We store manual overrides here. null means "use auto"
                    missed: 1, nonShockable: 0, pupilReactivity: 1, age: 0, phLow: 0, 
                    changingRhythms: 0, adrenaline: 0
                },
                plan: { ecg: '', management: '', furtherResus: 'Yes' }
            };

            const RHYTHMS = ['VF', 'pVT', 'PEA', 'Asystole'];
            const REVERSIBLES = ['Hypoxia', 'Hypovolaemia', 'Hypo/HyperK+', 'Hypothermia', 'Thrombosis', 'Tamponade', 'Toxins', 'Tension PTX'];
            const MIRACLE2_OUTCOMES = { 0: '~3%', 1: '~6%', 2: '~15%', 3: '~30%', 4: '~50%', 5: '~70%', 6: '~85%', 7: '~95%', 8: '~98%', 9: '~99%', 10: '>99%' };
            
            const getEl = (id) => document.getElementById(id);

            // --- NOTE GENERATOR ---
            function updateNotes() {
                const d = new Date();
                const ts = `${d.getDate()}/${d.getMonth()+1} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                
                let n = `*** CARDIAC ARREST PROFORMA ***\nDoc: ${ts}\n\n`;
                n += `ID: ${patientData.patientDetails || 'Unknown'} | Age: ${patientData.age || '?'}\n`;
                n += `Witnessed: ${patientData.witnessStatus} | Bystander CPR: ${patientData.bystanderCPR?'YES':'No'}\n`;
                n += `Hx: ${patientData.prearrest.history || '-'}\nRx: ${patientData.prearrest.interventions || '-'}\n\n`;
                
                n += `--- EVENTS ---\n`;
                n += `Arrest on Arrival: ${patientData.arrestOnArrival?'YES':'No'} | Pre-Hosp ROSC: ${patientData.roscAchieved?'YES':'No'}\n`;
                if(patientData.rearrested) n += `!!! PATIENT RE-ARRESTED POST-ROSC !!!\n`;
                
                if(patientData.arrestOnArrival || patientData.roscAchieved) {
                    const t = patientData.timeline;
                    n += `Times: Col ${t.collapse||'-'} / CPR ${t.cpr||'-'} / Defib ${t.defib||'-'} / ROSC ${t.rosc||'-'}\n`;
                    n += `Total Downtime: ${t.downtime||'?'} mins\n`;
                    n += `Rhythms: ${patientData.rhythms.join(', ')}\n`;
                    n += `Shocks: ${patientData.shocks||'0'} | Drugs: ${patientData.prehospital_drugs||'-'}\n`;
                }
                
                n += `\n--- POST-ROSC ---\n`;
                const pr = patientData.postROSC;
                n += `A: ${pr.airway.type}. ${pr.airway.notes}\n`;
                n += `B: ${pr.breathing.sounds}. RR ${pr.breathing.rr||'-'} Sats ${pr.breathing.sats||'-'}% EtCO2 ${pr.breathing.etco2||'-'}\n`;
                n += `C: HR ${pr.circulation.hr||'-'} BP ${pr.circulation.bp||'-'} MAP ${pr.circulation.map||'-'} T ${pr.circulation.temp||'-'}. ${pr.circulation.notes}\n`;
                
                const gcs = parseInt(pr.disability.gcsE)+parseInt(pr.disability.gcsV)+parseInt(pr.disability.gcsM);
                n += `D: GCS ${gcs} (E${pr.disability.gcsE}V${pr.disability.gcsV}M${pr.disability.gcsM}). Pupils: ${pr.disability.pupilsEq} ${pr.disability.pupilsSize} (${pr.disability.pupilReactivity}). BM ${pr.disability.glucose||'-'}\n`;
                n += `E: ${pr.exposure||'-'}\n`;
                
                n += `\nCauses Considered: ${patientData.reversibles.checked.join(', ') || 'None selected'}. ${patientData.reversibles.notes}\n`;
                
                const gas = patientData.bloodGas;
                n += `Gas (${gas.type}): FiO2 ${gas.fio2||'-'} | pH ${gas.ph} | pCO2 ${gas.pco2} | pO2 ${gas.po2} | Lac ${gas.lactate} | K ${gas.k}\n`;
                
                const m2 = patientData.miracle2;
                n += `\nMIRACLE² Score: ${m2.score} (${MIRACLE2_OUTCOMES[m2.score] || '?'})\n`;
                
                n += `\n--- PLAN ---\n`;
                n += `Further Resus: ${patientData.plan.furtherResus.toUpperCase()}\n`;
                n += `ECG/Img: ${patientData.plan.ecg||'-'}\n`;
                n += `Mgmt: ${patientData.plan.management||'-'}`;
                
                getEl('summaryNoteOutput').value = n;
            }

            // --- CALCULATORS ---
            function calcDowntime() {
                const c = getEl('time_collapse').value;
                const r = getEl('time_rosc').value;
                if(c && r) {
                    const d1 = new Date(`1970-01-01T${c}:00`);
                    const d2 = new Date(`1970-01-01T${r}:00`);
                    if(d2 < d1) d2.setDate(d2.getDate()+1);
                    const diff = Math.round((d2-d1)/60000);
                    patientData.timeline.downtime = diff;
                    getEl('downtime').value = diff;
                }
            }

            function calcMiracle2() {
                const m = patientData.miracle2;
                m.score = m.missed + m.nonShockable + m.pupilReactivity + m.age + m.changingRhythms + m.phLow + (m.adrenaline * 2);
                getEl('miracle2_score').textContent = m.score;
                getEl('miracle2_outcome').textContent = MIRACLE2_OUTCOMES[m.score] || '?';
                updateNotes();
            }

            // --- INIT ---
            function init() {
                // Generate Checkboxes
                const mkCheck = (val, id) => `<label class="cursor-pointer flex items-center space-x-2 p-2 bg-slate-50 border-2 border-slate-300 rounded hover:border-blue-400 transition-colors"><input type="checkbox" value="${val}" class="${id} w-4 h-4 text-blue-600 rounded"> <span class="text-xs font-bold text-slate-700">${val}</span></label>`;
                
                getEl('initialRhythm').innerHTML = RHYTHMS.map(r => mkCheck(r, 'rhythm-check')).join('');
                getEl('reversibles').innerHTML = REVERSIBLES.map(r => mkCheck(r, 'rev-check')).join('');

                // Generate Miracle 2 Rows with Manual Override
                const m2Con = getEl('miracle2_inputs');
                const m2Items = [
                    { id: 'missed', label: 'Unwitnessed' },
                    { id: 'nonShockable', label: 'Non-shockable' },
                    { id: 'pupilReactivity', label: 'No Pupil Reactivity' },
                    { id: 'phLow', label: 'pH < 7.20' },
                    { id: 'changingRhythms', label: 'Changing Rhythms (≥2)' },
                    { id: 'adrenaline', label: 'Epinephrine Given' }
                ];
                
                m2Items.forEach(i => {
                    m2Con.innerHTML += `
                    <div class="flex justify-between items-center border-b border-red-100 pb-2">
                        <span class="text-sm font-bold text-slate-700">${i.label}</span>
                        <div class="flex space-x-1">
                            <label class="cursor-pointer"><input type="radio" name="m2_${i.id}" value="1" class="sr-only peer"><span class="px-3 py-1 rounded text-xs font-bold border-2 border-slate-200 bg-white text-slate-400 peer-checked:bg-red-100 peer-checked:text-red-700 peer-checked:border-red-300 hover:bg-slate-50">YES</span></label>
                            <label class="cursor-pointer"><input type="radio" name="m2_${i.id}" value="0" class="sr-only peer"><span class="px-3 py-1 rounded text-xs font-bold border-2 border-slate-200 bg-white text-slate-400 peer-checked:bg-slate-200 peer-checked:text-slate-700 peer-checked:border-slate-300 hover:bg-slate-50">NO</span></label>
                        </div>
                    </div>`;
                });
                // Age is special
                m2Con.innerHTML += `<div class="flex justify-between items-center pt-1"><span class="text-sm font-bold text-slate-700">Age Points (0, 1, 3)</span><span id="m2_age_disp" class="text-sm font-black text-slate-400 bg-slate-100 px-2 py-1 rounded">0</span></div>`;
                
                // Set default M2 radios
                m2Items.forEach(i => {
                    const def = patientData.miracle2[i.id];
                    document.querySelector(`input[name="m2_${i.id}"][value="${def}"]`).checked = true;
                });

                // GCS Dropdowns
                const popSel = (id, max) => {
                    const s = getEl(id);
                    for(let i=max; i>=1; i--) s.add(new Option(i,i));
                };
                popSel('disability_gcsE', 4); popSel('disability_gcsV', 5); popSel('disability_gcsM', 6);

                setupListeners();
                updateNotes();
            }

            // --- LISTENERS ---
            function setupListeners() {
                // Re-arrest Toggle
                const ar = getEl('arrestOnArrival');
                const ro = getEl('roscAchieved');
                const ra = getEl('rearrested');
                
                [ar, ro].forEach(el => el.addEventListener('change', () => {
                    patientData[el.id] = el.checked;
                    const show = ar.checked || ro.checked;
                    getEl('timeline_details').classList.toggle('hidden', !show);
                    getEl('rearrestContainer').classList.toggle('hidden', !ro.checked); // Only show re-arrest if ROSC was achieved
                    updateNotes();
                }));

                ra.addEventListener('change', () => {
                    patientData.rearrested = ra.checked;
                    ra.parentElement.classList.toggle('bg-red-500', ra.checked);
                    ra.parentElement.classList.toggle('text-white', ra.checked);
                    ra.parentElement.classList.toggle('bg-red-100', !ra.checked);
                    updateNotes();
                });

                // Auto-updates for Miracle 2 from inputs
                const setM2 = (key, val) => {
                    patientData.miracle2[key] = val;
                    document.querySelector(`input[name="m2_${key}"][value="${val}"]`).checked = true;
                    calcMiracle2();
                };

                getEl('age').addEventListener('input', e => {
                    const v = parseInt(e.target.value);
                    patientData.age = v;
                    let p = 0; if(v>80) p=3; else if(v>=60) p=1;
                    patientData.miracle2.age = p;
                    getEl('m2_age_disp').textContent = p;
                    calcMiracle2();
                });

                getEl('witness_status').addEventListener('change', e => {
                    patientData.witnessStatus = e.target.value;
                    setM2('missed', e.target.value === 'Unwitnessed' ? 1 : 0);
                    updateNotes();
                });

                getEl('gas_ph').addEventListener('input', e => {
                    patientData.bloodGas.ph = e.target.value;
                    if(e.target.value && parseFloat(e.target.value) < 7.20) setM2('phLow', 1); else setM2('phLow', 0);
                    updateNotes();
                });

                document.body.addEventListener('change', e => {
                    if(e.target.classList.contains('rhythm-check')) {
                        const val = e.target.value;
                        if(e.target.checked) patientData.rhythms.push(val); 
                        else patientData.rhythms = patientData.rhythms.filter(x=>x!==val);
                        
                        const nonShock = patientData.rhythms.some(r=>['PEA','Asystole'].includes(r)) && !patientData.rhythms.some(r=>['VF','pVT'].includes(r));
                        setM2('nonShockable', nonShock ? 1 : 0);
                        updateNotes();
                    }
                });

                document.querySelectorAll('input[name="pupilReactivity"]').forEach(el => el.addEventListener('change', e => {
                    patientData.postROSC.disability.pupilReactivity = e.target.value;
                    setM2('pupilReactivity', e.target.value === 'None' ? 1 : 0);
                    updateNotes();
                }));

                // Manual M2 overrides
                document.querySelectorAll('input[name^="m2_"]').forEach(el => {
                    el.addEventListener('change', e => {
                        const key = e.target.name.replace('m2_', '');
                        patientData.miracle2[key] = parseInt(e.target.value);
                        calcMiracle2();
                    });
                });

                // General Bindings
                const bind = (id, root, key) => {
                    getEl(id).addEventListener('input', e => { root[key] = e.target.value; updateNotes(); });
                };
                bind('patient_details', patientData, 'patientDetails');
                bind('prearrest_history', patientData.prearrest, 'history');
                bind('prearrest_interventions', patientData.prearrest, 'interventions');
                bind('time_collapse', patientData.timeline, 'collapse');
                bind('time_cpr', patientData.timeline, 'cpr');
                bind('time_defib', patientData.timeline, 'defib');
                bind('time_rosc', patientData.timeline, 'rosc');
                bind('shocks', patientData, 'shocks');
                bind('prehospital_drugs', patientData, 'prehospital_drugs');
                bind('airway_notes', patientData.postROSC.airway, 'notes');
                bind('breathing_rr', patientData.postROSC.breathing, 'rr');
                bind('breathing_sats', patientData.postROSC.breathing, 'sats');
                bind('breathing_etco2', patientData.postROSC.breathing, 'etco2');
                bind('circ_hr', patientData.postROSC.circulation, 'hr');
                bind('circ_bp', patientData.postROSC.circulation, 'bp');
                bind('circ_map', patientData.postROSC.circulation, 'map');
                bind('circ_temp', patientData.postROSC.circulation, 'temp');
                bind('circ_notes', patientData.postROSC.circulation, 'notes');
                bind('disability_gcsE', patientData.postROSC.disability, 'gcsE'); // Select change events bubble
                bind('disability_gcsV', patientData.postROSC.disability, 'gcsV');
                bind('disability_gcsM', patientData.postROSC.disability, 'gcsM');
                bind('disability_pupils_size', patientData.postROSC.disability, 'pupilsSize');
                bind('disability_glucose', patientData.postROSC.disability, 'glucose');
                bind('exposure_notes', patientData.postROSC, 'exposure');
                bind('reversibles_notes', patientData.reversibles, 'notes');
                bind('gas_fio2', patientData.bloodGas, 'fio2');
                bind('gas_pco2', patientData.bloodGas, 'pco2');
                bind('gas_po2', patientData.bloodGas, 'po2');
                bind('gas_hco3', patientData.bloodGas, 'hco3');
                bind('gas_be', patientData.bloodGas, 'be');
                bind('gas_lactate', patientData.bloodGas, 'lactate');
                bind('gas_k', patientData.bloodGas, 'k');
                bind('plan_ecg', patientData.plan, 'ecg');
                bind('plan_management', patientData.plan, 'management');

                // Time calc trigger
                ['time_collapse', 'time_rosc'].forEach(id => getEl(id).addEventListener('input', calcDowntime));

                // Button Groups (Radios)
                document.querySelectorAll('input[name="airway_type"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.airway.type = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="breath_sounds"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.breathing.sounds = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="pupils_equal"]').forEach(r => r.addEventListener('change', e => { patientData.postROSC.disability.pupilsEq = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="gas_type"]').forEach(r => r.addEventListener('change', e => { patientData.bloodGas.type = e.target.value; updateNotes(); }));
                document.querySelectorAll('input[name="further_resus"]').forEach(r => r.addEventListener('change', e => { patientData.plan.furtherResus = e.target.value; updateNotes(); }));

                // Reversibles Checks
                document.body.addEventListener('change', e => {
                    if(e.target.classList.contains('rev-check')) {
                        const v = e.target.value;
                        if(e.target.checked) patientData.reversibles.checked.push(v);
                        else patientData.reversibles.checked = patientData.reversibles.checked.filter(x=>x!==v);
                        updateNotes();
                    }
                });

                // Add Bundle to Plan
                getEl('addBundleToPlan').addEventListener('click', () => {
                    const checks = Array.from(document.querySelectorAll('.bundle-check:checked')).map(c => c.value);
                    if(checks.length > 0) {
                        const txt = `RCUK Bundle: ${checks.join(', ')}.`;
                        const field = getEl('plan_management');
                        field.value = field.value ? field.value + '\n' + txt : txt;
                        patientData.plan.management = field.value;
                        updateNotes();
                    }
                });
                
                // Clear
                getEl('clearForm').addEventListener('click', () => { if(confirm('Reset all data?')) location.reload(); });
                getEl('copySummary').addEventListener('click', () => { navigator.clipboard.writeText(getEl('summaryNoteOutput').value); alert('Copied!'); });
            }

            init();
        });
    </script>
</body>
</html>
