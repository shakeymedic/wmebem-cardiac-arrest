<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiac Arrest & ROSC Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Auto-expanding textarea */
        textarea {
            field-sizing: content;
            min-height: 2.5rem;
            resize: none;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Utility Classes */
        .card { @apply bg-white p-5 rounded-xl shadow-sm border border-slate-200 transition-shadow duration-200; }
        .card-header { @apply flex items-center border-b border-slate-100 pb-3 mb-4; }
        .card-title { @apply text-lg font-bold text-slate-800; }
        .input-label { @apply block text-sm font-medium text-slate-600 mb-1.5; }
        .input-field { @apply w-full px-3 py-2.5 bg-white border border-slate-300 rounded-lg text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none; }
        .input-suffix-group { @apply relative flex items-center; }
        .input-suffix { @apply absolute right-3 text-xs font-medium text-slate-400 pointer-events-none; }
        .section-icon { @apply w-6 h-6 mr-3 text-blue-600; }
        
        /* Mobile Tab States */
        .tab-btn { @apply flex-1 py-3 text-sm font-semibold text-center border-b-2 transition-colors; }
        .tab-active { @apply border-blue-600 text-blue-600 bg-blue-50; }
        .tab-inactive { @apply border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50; }

        /* Locked inputs for MIRACLE2 */
        .locked-radio { @apply opacity-60 pointer-events-none grayscale; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
             <div class="flex items-center gap-4">
                <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-10 w-auto object-contain">
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-900 tracking-tight">Cardiac Arrest Tool</h1>
                    <p class="text-xs text-slate-500 font-medium">Structure. Safety. Speed.</p>
                </div>
            </div>
            <a href="https://wmebem.com" class="hidden sm:block text-sm font-medium text-blue-600 hover:text-blue-800">wmebem.com</a>
        </div>
    </header>

    <div class="lg:hidden flex bg-white border-b border-slate-200 sticky top-[65px] z-20">
        <button id="tabForm" class="tab-btn tab-active">Data Entry</button>
        <button id="tabSummary" class="tab-btn tab-inactive">Summary Note</button>
    </div>

    <main class="flex-grow container mx-auto px-4 py-6 overflow-hidden">
        
        <div class="h-full grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div id="inputColumn" class="lg:col-span-7 h-full overflow-y-auto custom-scroll pb-24 pr-1">
                
                <div class="mb-6">
                    <a href="https://wmebemals.netlify.app" target="_blank" class="flex items-center justify-center w-full bg-slate-800 text-white font-semibold py-3 px-4 rounded-lg shadow hover:bg-slate-700 transition-transform active:scale-[0.99]">
                        <span>Open WMEBEM ALS Algorithm</span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                </div>

                <div class="space-y-6">

                    <section class="card border-l-4 border-l-blue-500">
                        <div class="card-header">
                            <h2 class="card-title">Pre-Hospital Handover</h2>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 mb-4">
                             <div class="sm:col-span-3">
                                <label for="age" class="input-label">Age</label>
                                <input type="number" id="age" class="input-field" placeholder="Yr">
                            </div>
                            <div class="sm:col-span-9">
                                <label for="patient_details" class="input-label">Patient Details</label>
                                <input type="text" id="patient_details" class="input-field" placeholder="Name, DOB, Hospital No.">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div>
                                <label for="witness_status" class="input-label">Witnessed Status</label>
                                <select id="witness_status" class="input-field cursor-pointer">
                                    <option value="Unwitnessed">Unwitnessed</option>
                                    <option value="Bystander">Bystander Witnessed</option>
                                    <option value="Paramedic">Paramedic Witnessed</option>
                                </select>
                            </div>
                            <div class="flex items-end pb-2">
                                <label class="flex items-center space-x-3 cursor-pointer select-none group">
                                    <input type="checkbox" id="bystander_cpr" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <span class="font-medium text-slate-700 group-hover:text-blue-700">Bystander CPR?</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="prearrest_history" class="input-label">History / PC</label>
                                <textarea id="prearrest_history" class="input-field" placeholder="PMH, events leading to collapse..."></textarea>
                            </div>
                            <div>
                                <label for="prearrest_interventions" class="input-label">Pre-Arrest Interventions</label>
                                <textarea id="prearrest_interventions" class="input-field" placeholder="Meds given by crew before arrest..."></textarea>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 mt-6 pt-4 border-t border-slate-100">
                            <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition-colors w-full">
                                <input type="checkbox" id="arrestOnArrival" class="w-5 h-5 text-red-600 rounded border-slate-300 focus:ring-red-500">
                                <span class="ml-3 font-semibold text-slate-800">Arrest on Arrival?</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition-colors w-full">
                                <input type="checkbox" id="roscAchieved" class="w-5 h-5 text-green-600 rounded border-slate-300 focus:ring-green-500">
                                <span class="ml-3 font-semibold text-slate-800">Pre-Hospital ROSC?</span>
                            </label>
                        </div>

                        <div id="timeline_details" class="hidden mt-6 bg-blue-50 rounded-lg p-4 border border-blue-100">
                            <h3 class="font-bold text-blue-900 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Arrest Timeline
                            </h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                                <div><label class="input-label text-xs">Collapse</label><input type="time" id="time_collapse" class="input-field"></div>
                                <div><label class="input-label text-xs">1st CPR</label><input type="time" id="time_cpr" class="input-field"></div>
                                <div><label class="input-label text-xs">1st Defib</label><input type="time" id="time_defib" class="input-field"></div>
                                <div><label class="input-label text-xs">ROSC</label><input type="time" id="time_rosc" class="input-field"></div>
                            </div>
                             <div class="mb-4">
                                <label for="downtime" class="input-label">Total Downtime</label>
                                <div class="input-suffix-group">
                                    <input type="number" id="downtime" class="input-field bg-slate-100 font-bold text-slate-700" readonly>
                                    <span class="input-suffix">mins</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="input-label">Initial Rhythm(s)</label>
                                    <div id="initialRhythm" class="space-y-2 bg-white p-3 rounded border border-slate-200"></div>
                                </div>
                                <div>
                                    <label for="shocks" class="input-label">Shocks Delivered</label>
                                    <input type="number" id="shocks" class="input-field">
                                    <div class="mt-3">
                                        <label class="input-label">Arrest Drugs</label>
                                        <textarea id="prehospital_drugs" class="input-field" placeholder="Adrenaline, Amiodarone..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="input-label">Airway Management</label>
                                <textarea id="prehospital_airway" class="input-field" placeholder="Device, size, confirmation..."></textarea>
                            </div>
                        </div>
                    </section>

                    <section class="card border-l-4 border-l-green-500">
                        <div class="card-header">
                            <h2 class="card-title">Post-ROSC Assessment (ABCDE)</h2>
                        </div>
                        
                        <div class="mb-6">
                            <span class="inline-block px-2 py-1 bg-slate-100 text-xs font-bold text-slate-600 rounded mb-2">AIRWAY</span>
                            <textarea id="airway_notes" class="input-field" placeholder="Tube size, depth, cuff pressure, waveform..."></textarea>
                        </div>

                        <div class="mb-6">
                            <span class="inline-block px-2 py-1 bg-slate-100 text-xs font-bold text-slate-600 rounded mb-2">BREATHING</span>
                            <div class="grid grid-cols-3 gap-3 mb-2">
                                <div><label class="input-label">RR</label><div class="input-suffix-group"><input type="number" id="breathing_rr" class="input-field"><span class="input-suffix">/min</span></div></div>
                                <div><label class="input-label">Sats</label><div class="input-suffix-group"><input type="number" id="breathing_sats" class="input-field"><span class="input-suffix">%</span></div></div>
                                <div><label class="input-label">EtCO2</label><div class="input-suffix-group"><input type="number" id="breathing_etco2" class="input-field"><span class="input-suffix">kPa</span></div></div>
                            </div>
                            <textarea id="breathing_notes" class="input-field" placeholder="Vent settings, chest findings..."></textarea>
                        </div>

                        <div class="mb-6">
                            <span class="inline-block px-2 py-1 bg-slate-100 text-xs font-bold text-slate-600 rounded mb-2">CIRCULATION</span>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-2">
                                <div><label class="input-label">HR</label><div class="input-suffix-group"><input type="number" id="circ_hr" class="input-field"><span class="input-suffix">bpm</span></div></div>
                                <div><label class="input-label">BP</label><input type="text" id="circ_bp" class="input-field" placeholder="sys/dia"></div>
                                <div><label class="input-label">MAP</label><div class="input-suffix-group"><input type="number" id="circ_map" class="input-field"><span class="input-suffix">mmHg</span></div></div>
                                <div><label class="input-label">Temp</label><div class="input-suffix-group"><input type="number" id="circ_temp" class="input-field"><span class="input-suffix">°C</span></div></div>
                            </div>
                            <textarea id="circ_notes" class="input-field" placeholder="Peripheries, support requirements..."></textarea>
                        </div>

                        <div class="mb-6">
                            <span class="inline-block px-2 py-1 bg-slate-100 text-xs font-bold text-slate-600 rounded mb-2">DISABILITY</span>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
                                <div><label class="input-label">Eyes</label><select id="disability_gcsE" class="input-field"></select></div>
                                <div><label class="input-label">Verbal</label><select id="disability_gcsV" class="input-field"></select></div>
                                <div><label class="input-label">Motor</label><select id="disability_gcsM" class="input-field"></select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div><label class="input-label">Pupils</label><input type="text" id="disability_pupils" class="input-field" placeholder="Size (L/R)"></div>
                                <div><label class="input-label">Glucose</label><div class="input-suffix-group"><input type="number" id="disability_glucose" class="input-field"><span class="input-suffix">mmol/L</span></div></div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded border border-slate-100 mb-3">
                                <label class="input-label mb-2">Pupil Reactivity</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center space-x-2"><input type="radio" name="pupilReactivity" value="Brisk" class="text-blue-600 focus:ring-blue-500"><span>Brisk</span></label>
                                    <label class="flex items-center space-x-2"><input type="radio" name="pupilReactivity" value="Sluggish" class="text-blue-600 focus:ring-blue-500"><span>Sluggish</span></label>
                                    <label class="flex items-center space-x-2"><input type="radio" name="pupilReactivity" value="None" checked class="text-red-600 focus:ring-red-500"><span>None</span></label>
                                </div>
                            </div>
                            <textarea id="disability_notes" class="input-field" placeholder="Sedation, seizure activity..."></textarea>
                        </div>

                        <div>
                            <span class="inline-block px-2 py-1 bg-slate-100 text-xs font-bold text-slate-600 rounded mb-2">EXPOSURE</span>
                            <textarea id="exposure_notes" class="input-field" placeholder="Trauma check, lines, rashes..."></textarea>
                        </div>
                    </section>

                    <section class="card border-l-4 border-l-yellow-500">
                        <div class="card-header">
                            <h2 class="card-title">Reversible Causes</h2>
                        </div>
                        <div id="reversibles" class="grid grid-cols-2 gap-3 mb-4"></div>
                        <textarea id="reversibles_notes" class="input-field" placeholder="Specific notes on causes..."></textarea>
                    </section>

                    <section class="card border-l-4 border-l-purple-500">
                        <div class="card-header justify-between">
                            <h2 class="card-title">Blood Gas</h2>
                            <div class="flex space-x-3 bg-slate-100 rounded-lg p-1">
                                <label class="cursor-pointer px-3 py-1 rounded text-sm has-[:checked]:bg-white has-[:checked]:shadow transition-all"><input type="radio" name="gas_type" value="VBG" checked class="hidden"><span>VBG</span></label>
                                <label class="cursor-pointer px-3 py-1 rounded text-sm has-[:checked]:bg-white has-[:checked]:shadow transition-all"><input type="radio" name="gas_type" value="ABG" class="hidden"><span>ABG</span></label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="input-label">FiO2 / Oxygen</label>
                            <input type="text" id="gas_oxygen" class="input-field" placeholder="e.g. 15L NRB or 21%">
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <div><label class="input-label">pH</label><input type="number" step="0.01" id="gas_ph" class="input-field font-mono"></div>
                            <div><label class="input-label">pCO2</label><div class="input-suffix-group"><input type="number" step="0.1" id="gas_pco2" class="input-field font-mono"><span class="input-suffix">kPa</span></div></div>
                            <div><label class="input-label">pO2</label><div class="input-suffix-group"><input type="number" step="0.1" id="gas_po2" class="input-field font-mono"><span class="input-suffix">kPa</span></div></div>
                            <div><label class="input-label">HCO3</label><input type="number" step="0.1" id="gas_hco3" class="input-field font-mono"></div>
                            <div><label class="input-label">BE</label><input type="number" step="0.1" id="gas_be" class="input-field font-mono"></div>
                            <div><label class="input-label">Lactate</label><input type="number" step="0.1" id="gas_lactate" class="input-field font-mono font-bold text-purple-700"></div>
                            <div><label class="input-label">Hb</label><div class="input-suffix-group"><input type="number" id="gas_hb" class="input-field font-mono"><span class="input-suffix">g/L</span></div></div>
                            <div><label class="input-label">K+</label><div class="input-suffix-group"><input type="number" step="0.1" id="gas_k" class="input-field font-mono"><span class="input-suffix">mmol</span></div></div>
                            <div><label class="input-label">Na+</label><div class="input-suffix-group"><input type="number" id="gas_na" class="input-field font-mono"><span class="input-suffix">mmol</span></div></div>
                        </div>
                    </section>

                    <section class="card border-l-4 border-l-red-600 bg-red-50/30">
                        <div class="card-header">
                            <h2 class="card-title text-red-900">MIRACLE² Score</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="miracle2_inputs" class="space-y-4">
                                </div>
                            <div class="flex flex-col justify-center items-center bg-white border border-red-100 rounded-xl p-6 shadow-sm">
                                <span class="text-sm font-bold text-red-800 uppercase tracking-wider">Risk Score</span>
                                <span id="miracle2_score" class="text-6xl font-black text-red-600 my-2">0</span>
                                <div class="text-center">
                                    <p class="text-sm text-slate-500 mb-1">Probability of poor neuro outcome:</p>
                                    <p id="miracle2_outcome" class="text-xl font-bold text-slate-800">~3%</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="card border-l-4 border-l-slate-600">
                        <div class="card-header">
                            <h2 class="card-title">Management Plan</h2>
                        </div>
                        <div class="space-y-4">
                            <div><label class="input-label">12-Lead ECG</label><textarea id="plan_ecg" class="input-field" placeholder="STEMI? LBBB?"></textarea></div>
                            <div><label class="input-label">Bloods</label><textarea id="plan_bloods" class="input-field" placeholder="Sent? Requiring processing?"></textarea></div>
                            <div><label class="input-label">Imaging</label><textarea id="plan_imaging" class="input-field" placeholder="CT Brain/CAP? CXR?"></textarea></div>
                            <div><label class="input-label text-slate-900 font-bold">Immediate Plan</label><textarea id="plan_management" class="input-field bg-slate-50 border-slate-300" placeholder="Cardiology referral? ICU discussion? TTM target?"></textarea></div>
                        </div>
                    </section>

                    <button id="clearForm" class="w-full py-4 text-red-600 bg-red-50 hover:bg-red-100 font-bold rounded-lg transition-colors border border-red-200">
                        Clear All Data
                    </button>

                </div>
            </div>

            <div id="outputColumn" class="hidden lg:block lg:col-span-5 h-full lg:h-[calc(100vh-100px)] lg:sticky lg:top-24">
                <div class="card h-full flex flex-col p-0 overflow-hidden bg-slate-800 border-slate-700 shadow-xl">
                    <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                        <h2 class="font-bold text-white flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Generated Note
                        </h2>
                        <button id="copySummary" class="px-4 py-1.5 text-xs font-bold bg-blue-600 hover:bg-blue-500 text-white rounded-md transition-colors shadow">
                            COPY TEXT
                        </button>
                    </div>
                    <textarea readonly id="summaryNoteOutput" class="flex-grow w-full p-4 bg-slate-800 text-slate-100 font-mono text-sm leading-relaxed resize-none focus:outline-none" aria-label="Generated summary note"></textarea>
                </div>
            </div>

        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const patientData = {
                age: '', patientDetails: '',
                witnessStatus: 'Unwitnessed', bystanderCPR: false,
                prearrest: { history: '', interventions: '' },
                arrestOnArrival: false, roscAchieved: false,
                timeline: { collapse: '', cpr: '', defib: '', rosc: '', downtime: '' },
                rhythms: [], shocks: '', prehospital_drugs: '', prehospital_airway: '',
                postROSC: {
                    airway: '',
                    breathing: { rr: '', sats: '', etco2: '', notes: '' },
                    circulation: { hr: '', bp: '', map: '', temp: '', notes: '' },
                    disability: { gcsE: 1, gcsV: 1, gcsM: 1, pupils: '', pupilReactivity: 'None', glucose: '', notes: '' },
                    exposure: '',
                },
                reversibles: { checked: [], notes: '' },
                bloodGas: { type: 'VBG', oxygen: '', ph: '', pco2: '', po2: '', hco3: '', be: '', lactate: '', na: '', k: '', hb: '' },
                miracle2: {
                    score: 0,
                    missed: 1, nonShockable: 0, pupilReactivity: 1, age: 0, 
                    changingRhythms: 0, phLow: 0, adrenaline: 0
                },
                plan: { ecg: '', bloods: '', imaging: '', management: '' }
            };

            // --- UI CONSTANTS ---
            const RHYTHMS = ['VF', 'pVT', 'PEA', 'Asystole'];
            const REVERSIBLES = ['Hypoxia', 'Hypovolaemia', 'Hypo/Hyperkalaemia', 'Hypothermia', 'Thrombosis (Coronary/Pulmonary)', 'Tamponade', 'Toxins', 'Tension Pneumothorax'];
            const GCS_E_OPTIONS = [ { value: 1, label: '1 - None' }, { value: 2, label: '2 - To Pain' }, { value: 3, label: '3 - To Voice' }, { value: 4, label: '4 - Spontaneous' }];
            const GCS_V_OPTIONS = [ { value: 1, label: '1 - None' }, { value: 2, label: '2 - Incomprehensible' }, { value: 3, label: '3 - Inappropriate' }, { value: 4, label: '4 - Confused' }, { value: 5, label: '5 - Orientated' }];
            const GCS_M_OPTIONS = [ { value: 1, label: '1 - None' }, { value: 2, label: '2 - Extension' }, { value: 3, label: '3 - Flexion' }, { value: 4, label: '4 - Withdraws' }, { value: 5, label: '5 - Localises Pain' }, { value: 6, label: '6 - Obeys Commands' }];
            const MIRACLE2_COMPONENTS = [
                { id: 'missed', label: 'Unwitnessed Arrest?', auto: true },
                { id: 'nonShockable', label: 'Non-shockable Rhythm?', auto: true },
                { id: 'pupilReactivity', label: 'Non-reactive Pupils?', auto: true },
                { id: 'changingRhythms', label: 'Changing Rhythms (≥2)?', auto: false },
                { id: 'phLow', label: 'pH < 7.20?', auto: true },
                { id: 'adrenaline', label: 'Epinephrine Given?', auto: false }
            ];
            const MIRACLE2_OUTCOMES = { 0: '~3%', 1: '~6%', 2: '~15%', 3: '~30%', 4: '~50%', 5: '~70%', 6: '~85%', 7: '~95%', 8: '~98%', 9: '~99%', 10: '>99%' };

            const getEl = (id) => document.getElementById(id);
            const summaryNoteOutput = getEl('summaryNoteOutput');

            // --- NOTE GENERATION ---
            function updateNotes() {
                const d = new Date();
                const timestamp = `${d.getDate()}/${d.getMonth()+1} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                
                let note = `*** CARDIAC ARREST / ROSC PROFORMA ***\nDoc: ${timestamp}\n\n`;
                note += `PATIENT: ${patientData.patientDetails || 'Not specified'}\n`;
                note += `AGE: ${patientData.age || 'N/S'}\n\n`;
                
                note += `--- PRE-HOSPITAL ---\n`;
                note += `• Witnessed: ${patientData.witnessStatus}\n`;
                note += `• Bystander CPR: ${patientData.bystanderCPR ? 'Yes' : 'No'}\n`;
                note += `• Hx: ${patientData.prearrest.history || '-'}\n`;
                note += `• Pre-Arrest Rx: ${patientData.prearrest.interventions || '-'}\n\n`;

                note += `--- TIMELINE & ARRIVAL ---\n`;
                note += `• Cardiac Arrest on Arrival: ${patientData.arrestOnArrival ? 'YES' : 'No'}\n`;
                note += `• Pre-hospital ROSC: ${patientData.roscAchieved ? 'YES' : 'No'}\n`;
                
                if (patientData.arrestOnArrival || patientData.roscAchieved) {
                    const tl = patientData.timeline;
                    note += `• Collapse: ${tl.collapse || '-'}\n`;
                    note += `• CPR Start: ${tl.cpr || '-'}\n`;
                    note += `• 1st Shock: ${tl.defib || '-'}\n`;
                    note += `• ROSC Time: ${tl.rosc || '-'}\n`;
                    note += `• Downtime: ${tl.downtime || '?'} mins\n`;
                    note += `• Rhythms: ${patientData.rhythms.join(', ') || '-'}\n`;
                    note += `• Shocks: ${patientData.shocks || '0'}\n`;
                    note += `• Drugs: ${patientData.prehospital_drugs || '-'}\n`;
                    note += `• Airway: ${patientData.prehospital_airway || '-'}\n`;
                }
                note += `\n`;

                const pr = patientData.postROSC;
                const totalGCS = parseInt(pr.disability.gcsE) + parseInt(pr.disability.gcsV) + parseInt(pr.disability.gcsM);
                
                note += `--- POST-ROSC (ABCDE) ---\n`;
                note += `A: ${pr.airway || 'Not documented'}\n`;
                note += `B: RR ${pr.breathing.rr||'-'} | Sats ${pr.breathing.sats||'-'}% | EtCO2 ${pr.breathing.etco2||'-'}\n`;
                if(pr.breathing.notes) note += `   Note: ${pr.breathing.notes}\n`;
                
                note += `C: HR ${pr.circulation.hr||'-'} | BP ${pr.circulation.bp||'-'} | MAP ${pr.circulation.map||'-'} | T ${pr.circulation.temp||'-'}\n`;
                if(pr.circulation.notes) note += `   Note: ${pr.circulation.notes}\n`;
                
                note += `D: GCS ${totalGCS} (E${pr.disability.gcsE} V${pr.disability.gcsV} M${pr.disability.gcsM})\n`;
                note += `   Pupils: ${pr.disability.pupils||'-'} (${pr.disability.pupilReactivity})\n`;
                note += `   BM: ${pr.disability.glucose||'-'}\n`;
                if(pr.disability.notes) note += `   Note: ${pr.disability.notes}\n`;
                
                note += `E: ${pr.exposure || '-'}\n\n`;

                note += `--- REVERSIBLES ---\n`;
                note += `• Checked: ${patientData.reversibles.checked.join(', ') || 'None selected'}\n`;
                note += `• Notes: ${patientData.reversibles.notes || '-'}\n\n`;

                const gas = patientData.bloodGas;
                note += `--- ${gas.type} (${gas.oxygen || 'Room Air'}) ---\n`;
                note += `pH: ${gas.ph||'-'} | pCO2: ${gas.pco2||'-'} | pO2: ${gas.po2||'-'}\n`;
                note += `HCO3: ${gas.hco3||'-'} | BE: ${gas.be||'-'} | Lac: ${gas.lactate||'-'}\n`;
                note += `Hb: ${gas.hb||'-'} | Na: ${gas.na||'-'} | K: ${gas.k||'-'}\n\n`;

                const m2 = patientData.miracle2;
                note += `--- MIRACLE² SCORE: ${m2.score} ---\n`;
                note += `(Est. poor Neuro Outcome: ${MIRACLE2_OUTCOMES[m2.score] || '?'})\n`;
                note += `[${m2.missed?'x':' '}] Unwitnessed (Missed)\n`;
                note += `[${m2.nonShockable?'x':' '}] Initial Non-Shockable\n`;
                note += `[${m2.pupilReactivity?'x':' '}] No Pupil Reactivity\n`;
                note += `[${m2.age > 0 ?'x':' '}] Age >60 (+1) or >80 (+3) [Pts: ${m2.age}]\n`;
                note += `[${m2.changingRhythms?'x':' '}] Changing Rhythms\n`;
                note += `[${m2.phLow?'x':' '}] pH < 7.20\n`;
                note += `[${m2.adrenaline?'x':' '}] Epinephrine given\n\n`;

                const plan = patientData.plan;
                note += `--- PLAN ---\n`;
                note += `• ECG: ${plan.ecg || 'Pending'}\n`;
                note += `• Bloods: ${plan.bloods || 'Pending'}\n`;
                note += `• Imaging: ${plan.imaging || 'Pending'}\n`;
                note += `• IMMEDIATE: ${plan.management || 'To be determined'}\n`;

                summaryNoteOutput.value = note;
                
                // Trigger resizing of the output box if needed
                summaryNoteOutput.style.height = 'auto';
                summaryNoteOutput.style.height = summaryNoteOutput.scrollHeight + 'px';
            }

            // --- CALCULATORS ---
            function calculateAndDisplayDowntime() {
                const collapse = getEl('time_collapse').value;
                const rosc = getEl('time_rosc').value;
                const out = getEl('downtime');
                
                if (collapse && rosc) {
                    const d1 = new Date(`1970-01-01T${collapse}:00`);
                    const d2 = new Date(`1970-01-01T${rosc}:00`);
                    if (d2 < d1) d2.setDate(d2.getDate() + 1);
                    const diff = Math.round((d2 - d1) / 60000);
                    patientData.timeline.downtime = diff >= 0 ? diff : '?';
                } else {
                    patientData.timeline.downtime = '';
                }
                out.value = patientData.timeline.downtime;
                updateNotes();
            }

            function calculateMiracle2Score() {
                const m2 = patientData.miracle2;
                m2.score = m2.missed + m2.nonShockable + m2.pupilReactivity + m2.age + m2.changingRhythms + m2.phLow + (m2.adrenaline * 2);
                getEl('miracle2_score').textContent = m2.score;
                getEl('miracle2_outcome').textContent = MIRACLE2_OUTCOMES[m2.score] || '?';
                updateNotes();
            }

            // --- INITIALIZATION ---
            function init() {
                // Generate checkbox grids
                const mkCheckbox = (val, group) => `
                    <label class="flex items-center space-x-2 p-2 border border-slate-200 rounded hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" value="${val}" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-slate-300" data-group="${group}">
                        <span class="text-sm text-slate-700">${val}</span>
                    </label>`;
                
                getEl('initialRhythm').innerHTML = RHYTHMS.map(r => mkCheckbox(r, 'rhythm')).join('');
                getEl('reversibles').innerHTML = REVERSIBLES.map(r => mkCheckbox(r, 'rev')).join('');

                // Generate MIRACLE2
                const m2Container = getEl('miracle2_inputs');
                m2Container.innerHTML = MIRACLE2_COMPONENTS.map(c => `
                    <div class="flex justify-between items-center py-2 border-b border-dashed border-red-100 last:border-0">
                        <span class="text-sm font-medium text-slate-700 ${c.auto ? 'flex items-center gap-1':''}">
                            ${c.label}
                            ${c.auto ? '<svg class="w-3 h-3 text-slate-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm0-4H9V7h2v5z"/></svg>' : ''}
                        </span>
                        <div class="flex space-x-1 ${c.auto ? 'locked-radio':''}">
                            <label class="px-2 py-1 text-xs border rounded cursor-pointer has-[:checked]:bg-red-100 has-[:checked]:text-red-700 has-[:checked]:border-red-200 hover:bg-slate-50">
                                <input type="radio" name="m2_${c.id}" value="1" class="hidden"> Yes
                            </label>
                            <label class="px-2 py-1 text-xs border rounded cursor-pointer has-[:checked]:bg-slate-200 has-[:checked]:text-slate-800 hover:bg-slate-50">
                                <input type="radio" name="m2_${c.id}" value="0" checked class="hidden"> No
                            </label>
                        </div>
                    </div>
                `).join('');
                // Add age row separately
                m2Container.innerHTML += `
                    <div class="flex justify-between items-center pt-2 mt-2 border-t border-red-100">
                        <span class="text-sm font-medium text-slate-700 flex items-center gap-1">Age Points <svg class="w-3 h-3 text-slate-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm0-4H9V7h2v5z"/></svg></span>
                        <span id="miracle2_age_display" class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-600">0</span>
                    </div>`;

                // Setup Inputs
                document.querySelectorAll('input, textarea, select').forEach(el => {
                    // Auto-resize
                    if(el.tagName === 'TEXTAREA') {
                        el.addEventListener('input', function() {
                            this.style.height = 'auto';
                            this.style.height = this.scrollHeight + 'px';
                        });
                    }
                    
                    // Main Listener
                    el.addEventListener('input', (e) => {
                        const id = e.target.id;
                        const val = e.target.value;
                        
                        // Map IDs to Data
                        if(id === 'age') {
                            patientData.age = val;
                            let pts = 0;
                            if(val > 80) pts = 3; else if(val >= 60) pts = 1;
                            patientData.miracle2.age = pts;
                            getEl('miracle2_age_display').textContent = pts > 0 ? `+${pts}` : '0';
                            calculateMiracle2Score();
                        }
                        else if(id === 'witness_status') {
                            patientData.witnessStatus = val;
                            const unwitnessed = val === 'Unwitnessed';
                            patientData.miracle2.missed = unwitnessed ? 1 : 0;
                            document.querySelector(`input[name="m2_missed"][value="${unwitnessed?1:0}"]`).checked = true;
                            calculateMiracle2Score();
                        }
                        else if(id === 'gas_ph') {
                            patientData.bloodGas.ph = val;
                            const low = parseFloat(val) < 7.20;
                            patientData.miracle2.phLow = low ? 1 : 0;
                            document.querySelector(`input[name="m2_phLow"][value="${low?1:0}"]`).checked = true;
                            calculateMiracle2Score();
                        }
                        else if(id.startsWith('gas_')) {
                            patientData.bloodGas[id.replace('gas_','')] = val;
                        }
                        else if(id.startsWith('disability_gcs')) {
                            patientData.postROSC.disability[id.split('_')[1]] = val;
                        }
                        else if(id.startsWith('breathing_')) {
                            patientData.postROSC.breathing[id.split('_')[1]] = val;
                        }
                        else if(id.startsWith('circ_')) {
                            patientData.postROSC.circulation[id.split('_')[1]] = val;
                        }
                        else if(id.startsWith('plan_')) {
                            patientData.plan[id.split('_')[1]] = val;
                        }
                        // Simple mappings
                        else if(patientData.hasOwnProperty(id)) patientData[id] = val;
                        else if(patientData.prearrest.hasOwnProperty(id.replace('prearrest_',''))) patientData.prearrest[id.replace('prearrest_','')] = val;
                        else if(id.includes('airway')) patientData.postROSC.airway = val; // rough match for airway notes
                        else if(id.includes('pupils')) patientData.postROSC.disability.pupils = val;
                        else if(id.includes('glucose')) patientData.postROSC.disability.glucose = val;
                        else if(id.includes('exposure')) patientData.postROSC.exposure = val;
                        else if(id.includes('reversibles_')) patientData.reversibles.notes = val;
                        
                        // Time & Calc triggers
                        if(id.includes('time_')) {
                            patientData.timeline[id.replace('time_','')] = val;
                            calculateAndDisplayDowntime();
                        }

                        updateNotes();
                    });
                });

                // Checkbox Groups
                document.body.addEventListener('change', (e) => {
                    if(e.target.dataset.group === 'rhythm') {
                        const val = e.target.value;
                        if(e.target.checked) patientData.rhythms.push(val);
                        else patientData.rhythms = patientData.rhythms.filter(x => x !== val);
                        
                        // M2 logic
                        const nonShock = patientData.rhythms.some(r => ['PEA','Asystole'].includes(r)) && !patientData.rhythms.some(r => ['VF','pVT'].includes(r));
                        patientData.miracle2.nonShockable = nonShock ? 1 : 0;
                        document.querySelector(`input[name="m2_nonShockable"][value="${nonShock?1:0}"]`).checked = true;
                        calculateMiracle2Score();
                        updateNotes();
                    }
                    if(e.target.dataset.group === 'rev') {
                        const val = e.target.value;
                        if(e.target.checked) patientData.reversibles.checked.push(val);
                        else patientData.reversibles.checked = patientData.reversibles.checked.filter(x => x !== val);
                        updateNotes();
                    }
                });

                // MIRACLE2 Manual Radios
                ['changingRhythms', 'adrenaline'].forEach(key => {
                     document.querySelectorAll(`input[name="m2_${key}"]`).forEach(r => {
                         r.addEventListener('change', (e) => {
                             patientData.miracle2[key] = parseInt(e.target.value);
                             calculateMiracle2Score();
                         });
                     });
                });

                // Specific Toggles
                getEl('arrestOnArrival').addEventListener('change', (e) => {
                    patientData.arrestOnArrival = e.target.checked;
                    getEl('timeline_details').classList.toggle('hidden', !patientData.arrestOnArrival && !patientData.roscAchieved);
                    updateNotes();
                });
                getEl('roscAchieved').addEventListener('change', (e) => {
                    patientData.roscAchieved = e.target.checked;
                    getEl('timeline_details').classList.toggle('hidden', !patientData.arrestOnArrival && !patientData.roscAchieved);
                    updateNotes();
                });
                getEl('bystander_cpr').addEventListener('change', e => { patientData.bystanderCPR = e.target.checked; updateNotes(); });
                
                document.querySelectorAll('input[name="pupilReactivity"]').forEach(r => {
                    r.addEventListener('change', e => {
                        patientData.postROSC.disability.pupilReactivity = e.target.value;
                        const none = e.target.value === 'None';
                        patientData.miracle2.pupilReactivity = none ? 1 : 0;
                        document.querySelector(`input[name="m2_pupilReactivity"][value="${none?1:0}"]`).checked = true;
                        calculateMiracle2Score();
                        updateNotes();
                    });
                });

                // Populate GCS
                const fillSel = (id, opts) => opts.forEach(o => getEl(id).add(new Option(o.label, o.value)));
                fillSel('disability_gcsE', GCS_E_OPTIONS);
                fillSel('disability_gcsV', GCS_V_OPTIONS);
                fillSel('disability_gcsM', GCS_M_OPTIONS);

                // Mobile Tabs
                const tabForm = getEl('tabForm');
                const tabSum = getEl('tabSummary');
                const colIn = getEl('inputColumn');
                const colOut = getEl('outputColumn');

                const switchTab = (showForm) => {
                    if(showForm) {
                        colIn.classList.remove('hidden');
                        colOut.classList.add('hidden');
                        tabForm.className = 'tab-btn tab-active';
                        tabSum.className = 'tab-btn tab-inactive';
                    } else {
                        colIn.classList.add('hidden');
                        colOut.classList.remove('hidden');
                        tabForm.className = 'tab-btn tab-inactive';
                        tabSum.className = 'tab-btn tab-active';
                    }
                };
                
                tabForm.addEventListener('click', () => switchTab(true));
                tabSum.addEventListener('click', () => switchTab(false));

                // Clear & Copy
                getEl('clearForm').addEventListener('click', () => {
                    if(confirm('Are you sure? This will delete all entered data.')) location.reload();
                });
                
                getEl('copySummary').addEventListener('click', () => {
                   summaryNoteOutput.select();
                   navigator.clipboard.writeText(summaryNoteOutput.value).then(() => alert('Copied to clipboard!'));
                });

                // Init
                updateNotes();
            }

            init();
        });
    </script>
</body>
</html>
